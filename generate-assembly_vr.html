<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Assembly Viewer + VR & AR</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ§±</text></svg>">
  <style>
    :root { color-scheme: light; }
    html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#fff; color:#000; }
    #app { display:grid; grid-template-rows:auto 1fr auto; height:100%; max-width:980px; margin:0 auto; }
    header { padding:12px 16px; border-bottom:1px solid #000; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:16px; margin:0 8px 0 0; font-weight:700; }
    input[type="file"], input[type="text"] { border:1px solid #000; padding:8px; background:#fff; color:#000; border-radius:0; font-size:14px; }
    button { background:#000; color:#fff; border:none; border-radius:0; padding:10px 12px; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .ghost { background:#fff; color:#000; border:1px solid #000; }
    #viewer { position:relative; height:60vh; }
    #three-canvas { width:100%; height:100%; display:block; }
    #hud { position:absolute; top:10px; left:10px; display:flex; gap:8px; flex-wrap:wrap; z-index:2; }
    #msg { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; white-space:pre-wrap; }
    #controls { padding:12px 16px; border-top:1px solid #000; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    #controls .left, #controls .right { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { padding:6px 10px; border:1px dashed #000; background:#fff; font-size:12px; }
    label.slider { display:flex; align-items:center; gap:8px; font-size:12px; }
    input[type="range"] { accent-color:#000; }
    #ar-launch-ios { display:none; } /* becomes visible if iOS detected */
    #ar-viewer { width:1px; height:1px; position:absolute; left:-9999px; top:-9999px; } /* hidden model-viewer used only for AR launch */
    .hint { font-size:12px; opacity:.8; }
  </style>
  <!-- three.js + helpers -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <!-- model-viewer for AR (Android Scene Viewer / WebXR; iOS will use Quick Look via USDZ link) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Assembly â†’ VR & AR</h1>
      <input id="object-name" type="text" placeholder="Object nameâ€¦" style="min-width:160px"/>
      <input id="json-file" type="file" accept=".json"/>
      <button id="load-demo" class="ghost">Load Demo</button>
      <span class="pill">iOS: Quick Look (USDZ) Â· Android: Scene Viewer (GLB)</span>
    </header>

    <main id="viewer">
      <canvas id="three-canvas"></canvas>
      <div id="hud">
        <button id="btn-reset" title="Reset View">Reset</button>
        <button id="btn-explode" class="ghost" title="Explode View">Explode</button>
        <button id="btn-vr" title="Enter VR" disabled>Enter VR</button>
        <button id="btn-ar-ios" title="Place in Room (iOS)" style="display:none">Place in Room (iOS)</button>
        <button id="btn-ar-android" class="ghost" title="Place in Room (Android)">Place in Room</button>
      </div>
      <div id="msg" style="position:absolute; right:10px; top:10px; max-width:50ch;"></div>
      <!-- Hidden AR launcher (Android / WebXR via model-viewer) -->
      <model-viewer id="ar-viewer"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        environment-image="neutral"
        exposure="1"
        shadow-intensity="0"
        style="display:none">
      </model-viewer>
      <!-- iOS AR Quick Look trigger -->
      <a id="ar-launch-ios" rel="ar" href="#">View in AR</a>
    </main>

    <footer id="controls">
      <div class="left">
        <label class="slider">Scale
          <input id="scale-range" type="range" min="0.1" max="4" step="0.01" value="1"/>
          <span id="scale-value">1.00Ã—</span>
        </label>
        <span class="hint">Use this before entering VR/AR to size the object.</span>
      </div>
      <div class="right">
        <button id="btn-export-glb" class="ghost">Export GLB</button>
        <button id="btn-export-usdz" class="ghost">Export USDZ</button>
      </div>
    </footer>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { VRButton } from 'three/addons/webxr/VRButton.js';
    import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';
    import { USDZExporter } from 'three/addons/exporters/USDZExporter.js';

    // --- DOM
    const canvas = document.getElementById('three-canvas');
    const msg = document.getElementById('msg');
    const objectNameInput = document.getElementById('object-name');
    const jsonFile = document.getElementById('json-file');
    const btnDemo = document.getElementById('load-demo');
    const btnReset = document.getElementById('btn-reset');
    const btnExplode = document.getElementById('btn-explode');
    const btnVR = document.getElementById('btn-vr');
    const btnARIOS = document.getElementById('btn-ar-ios');
    const iosARLink = document.getElementById('ar-launch-ios');
    const btnARAndroid = document.getElementById('btn-ar-android');
    const mv = document.getElementById('ar-viewer');
    const scaleRange = document.getElementById('scale-range');
    const scaleValue = document.getElementById('scale-value');
    const btnExportGLB = document.getElementById('btn-export-glb');
    const btnExportUSDZ = document.getElementById('btn-export-usdz');

    // --- THREE basics
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
    renderer.xr.enabled = true; // allow VR if present

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(55, 1, 0.01, 1000);
    camera.position.set(1.2, 1.0, 1.2);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const ambient = new THREE.AmbientLight(0xffffff, 0.9);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(3, 5, 2);
    scene.add(ambient, dir);

    const root = new THREE.Group();
    scene.add(root);

    const defaultMat = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.85 });
    const edgeMat = new THREE.LineBasicMaterial({ color: 0x111111, transparent: true, opacity: 0.7 });

    let currentJSON = null;
    let originalPositions = new Map(); // for explode/reset
    let explodeOn = false;

    function fitCameraToObject(object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      controls.target.copy(center);
      camera.position.copy(center.clone().add(new THREE.Vector3(size.x, size.y, size.z).multiplyScalar(1.2)));
      camera.near = Math.max(0.01, Math.min(size.length() / 100, 0.1));
      camera.far = Math.max(10, size.length() * 10);
      camera.updateProjectionMatrix();
    }

    function clearModel() {
      while (root.children.length) root.remove(root.children[0]);
      originalPositions.clear();
    }

    function buildFromJSON(json) {
      clearModel();
      currentJSON = json;
      objectNameInput.value = json.objectName || 'Untitled';

      if (!json.parts || !Array.isArray(json.parts) || json.parts.length === 0) {
        setMsg('No parts found in JSON.');
        return;
      }
      json.parts.forEach(part => {
        const w = Number(part.dimensions?.width ?? 0.1);
        const h = Number(part.dimensions?.height ?? 0.1);
        const d = Number(part.dimensions?.depth ?? 0.1);
        const geo = new THREE.BoxGeometry(w, h, d);

        const g = new THREE.Group();
        const mesh = new THREE.Mesh(geo, defaultMat);
        const edges = new THREE.LineSegments(new THREE.EdgesGeometry(geo), edgeMat);
        g.add(mesh, edges);

        const x = Number(part.origin?.x ?? 0);
        const y = Number(part.origin?.y ?? 0);
        const z = Number(part.origin?.z ?? 0);
        g.position.set(x, y, z);

        // Rotation if provided (YXZ order)
        const rot = part.rotation;
        if (rot && typeof rot === 'object') {
          g.rotation.set(rot.x || 0, rot.y || 0, rot.z || 0, 'YXZ');
        }

        originalPositions.set(g, g.position.clone());
        root.add(g);
      });

      root.scale.setScalar(Number(scaleRange.value));
      fitCameraToObject(root);
      setMsg(`Loaded: ${json.parts.length} part(s).`);
    }

    function setMsg(t) {
      msg.textContent = t;
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
      renderer.render(scene, camera);
    }
    animate();

    // --- Explode / Reset
    function explodeParts(on) {
      const box = new THREE.Box3().setFromObject(root);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const explodeFactor = Math.max(size.x, size.y, size.z) * 0.25;

      root.children.forEach(ch => {
        const from = originalPositions.get(ch);
        if (!from) return;
        if (on) {
          const dir = from.clone().sub(center).normalize().multiplyScalar(explodeFactor);
          ch.position.copy(from.clone().add(dir));
        } else {
          ch.position.copy(from);
        }
      });
    }

    // --- Export helpers
    async function exportGLBBlob() {
      const exporter = new GLTFExporter();
      const clone = root.clone(true);
      return new Promise((resolve, reject) => {
        exporter.parse(
          clone,
          glb => {
            const blob = new Blob([glb], { type: 'model/gltf-binary' });
            resolve(blob);
          },
          err => reject(err),
          { binary: true }
        );
      });
    }

    async function exportUSDZBlob() {
      const exporter = new USDZExporter();
      const arraybuffer = await exporter.parse(root, { includeUVs: false });
      return new Blob([arraybuffer], { type: 'model/vnd.usdz+zip' });
    }

    function downloadBlob(blob, filename) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    // --- Platform checks
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // Show proper AR buttons
    if (isIOS) {
      btnARIOS.style.display = '';
      iosARLink.style.display = 'inline-block';
      btnARAndroid.style.display = 'none';
    }

    // VR availability (immersive-vr)
    if (navigator.xr && navigator.xr.isSessionSupported) {
      navigator.xr.isSessionSupported('immersive-vr').then(supported => {
        if (supported) {
          btnVR.disabled = false;
        }
      });
    }

    // --- Events
    jsonFile.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const text = await f.text();
      try {
        const json = JSON.parse(text);
        buildFromJSON(json);
      } catch (err) {
        setMsg('Invalid JSON: ' + err.message);
      }
    });

    btnDemo.addEventListener('click', () => {
      const demo = {
        "objectName": "Demo Chair (Boxy)",
        "parts": [
          { "id":"seat","origin":{"x":0,"y":0.45,"z":0},"dimensions":{"width":0.46,"height":0.04,"depth":0.46},"connections":["leg_fl","leg_fr","leg_rl","leg_rr","back"} },
          { "id":"leg_fl","origin":{"x":-0.2,"y":0.22,"z":-0.2},"dimensions":{"width":0.04,"height":0.44,"depth":0.04},"connections":["seat"] },
          { "id":"leg_fr","origin":{"x":0.2,"y":0.22,"z":-0.2},"dimensions":{"width":0.04,"height":0.44,"depth":0.04},"connections":["seat"] },
          { "id":"leg_rl","origin":{"x":-0.2,"y":0.22,"z":0.2},"dimensions":{"width":0.04,"height":0.44,"depth":0.04},"connections":["seat","back"] },
          { "id":"leg_rr","origin":{"x":0.2,"y":0.22,"z":0.2},"dimensions":{"width":0.04,"height":0.44,"depth":0.04},"connections":["seat","back"] },
          { "id":"back","origin":{"x":0,"y":0.75,"z":0.22},"dimensions":{"width":0.46,"height":0.5,"depth":0.04},"connections":["seat","leg_rl","leg_rr"] }
        ]
      };
      buildFromJSON(demo);
    });

    btnReset.addEventListener('click', () => {
      explodeOn = false;
      explodeParts(false);
      root.scale.setScalar(Number(scaleRange.value));
      fitCameraToObject(root);
    });

    btnExplode.addEventListener('click', () => {
      explodeOn = !explodeOn;
      explodeParts(explodeOn);
    });

    // VR button uses three.js VRButton under the hood
    btnVR.addEventListener('click', () => {
      // Attach VRButton lazily to body (creates the native button + enters session)
      const vrBtn = VRButton.createButton(renderer);
      vrBtn.style.display = 'none';
      document.body.appendChild(vrBtn);
      vrBtn.click();
    });

    // AR (Android via model-viewer)
    btnARAndroid.addEventListener('click', async () => {
      if (!currentJSON) { setMsg('Load an assembly JSON first.'); return; }
      try {
        setMsg('Preparing GLB for ARâ€¦');
        const glb = await exportGLBBlob();
        const url = URL.createObjectURL(glb);
        mv.src = url;
        mv.scale = `${root.scale.x} ${root.scale.y} ${root.scale.z}`; // applied in webxr mode
        // Trigger AR
        mv.activateAR();
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
        setMsg('If nothing happens, ensure Chrome with Scene Viewer is available.');
      } catch (err) {
        setMsg('GLB export failed: ' + err.message);
      }
    });

    // AR (iOS via Quick Look USDZ)
    btnARIOS.addEventListener('click', async () => {
      if (!currentJSON) { setMsg('Load an assembly JSON first.'); return; }
      try {
        setMsg('Preparing USDZ for iOS ARâ€¦');
        const usdz = await exportUSDZBlob();
        const url = URL.createObjectURL(usdz);
        iosARLink.href = url;
        iosARLink.click(); // open Quick Look
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
      } catch (err) {
        setMsg('USDZ export failed: ' + err.message);
      }
    });

    // Exports
    btnExportGLB.addEventListener('click', async () => {
      if (!currentJSON) { setMsg('Load an assembly JSON first.'); return; }
      try {
        const glb = await exportGLBBlob();
        const name = (objectNameInput.value || 'object').replace(/\\s+/g, '_');
        downloadBlob(glb, name + '.glb');
        setMsg('GLB exported.');
      } catch (err) {
        setMsg('GLB export failed: ' + err.message);
      }
    });

    btnExportUSDZ.addEventListener('click', async () => {
      if (!currentJSON) { setMsg('Load an assembly JSON first.'); return; }
      try {
        const usdz = await exportUSDZBlob();
        const name = (objectNameInput.value || 'object').replace(/\\s+/g, '_');
        downloadBlob(usdz, name + '.usdz');
        setMsg('USDZ exported.');
      } catch (err) {
        setMsg('USDZ export failed: ' + err.message);
      }
    });

    // Scaling
    scaleRange.addEventListener('input', () => {
      const s = Number(scaleRange.value);
      root.scale.setScalar(s);
      scaleValue.textContent = s.toFixed(2) + 'Ã—';
    });

    // Resize
    const ro = new ResizeObserver(() => {
      renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    });
    ro.observe(document.getElementById('viewer'));

    // Friendly startup message
    setMsg('Load an assembly JSON (same schema as your app). Then: â€¢ Enter VR (if available) â€¢ Place in Room (iOS/Android).');
  </script>
</body>
</html>
