<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Generate Model</title>
    <style>
        /* General Body and Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            color: #000000;
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        /* A single container for the whole app */
        #app-wrapper {
            width: 90%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Top UI Container */
        .top-input-row {
            display: flex;
            align-items: stretch; /* Makes items same height */
            gap: 10px;
        }
        #object-name {
            flex-grow: 1;
            background-color: #f0f0f0;
            padding: 12px;
            border: 1px solid #000;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
        }
        #api-key-btn {
            flex-shrink: 0; padding: 12px 15px; background-color: #000; color: #fff;
            border: none; border-radius: 0; cursor: pointer; font-size: 12px; font-weight: 600;
            box-sizing: border-box;
        }

        /* 3D Viewer Container */
        #viewer-container {
            width: 100%;
            height: 40vh;
            position: relative;
            background-color: #ffffff;
        }
        #viewer-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Bottom UI Container */
        #bottom-ui-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .icon-controls { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; }
        .icon-button { cursor: pointer; color: #000; }
        .icon-button svg { width: 18px; height: 18px; } /* Icons made 25% smaller */
        .icon-button .label { font-size: 12px; margin-top: 5px; }
        
        .action-buttons { display: flex; gap: 10px; }
        .btn {
            flex-grow: 1; padding: 12px; font-size: 14px; font-weight: 600;
            border: none; border-radius: 0; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            background-color: #000000; color: #ffffff;
        }
        
        .instructions-group { background-color: #ffffff; padding: 15px; border: 1px solid #000; }
        .instructions-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #000; }
        .instructions-group textarea {
            width: 100%; height: 60px; /* Comment field height reduced */
            padding: 10px; border: none; 
            background-color: #fff; color: #000; border-radius: 0;
            font-size: 14px; box-sizing: border-box; resize: vertical;
        }

        .hans-group { background-color: #000; color: #fff; padding: 15px; }
        #hans-output { font-family: "SF Mono", "Consolas", "Menlo", monospace; font-size: 13px; line-height: 1.5; min-height: 20px; }
        #hans-output-text { white-space: pre-wrap; }
        .cursor { display: inline-block; background-color: #fff; width: 8px; height: 1em; animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent } 50% { background-color: #fff; } }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 0; border: 1px solid #000; width: 100%; max-width: 600px; display: flex; flex-direction: column; }
        .modal-content h3 { margin-top: 0; color: #000; }
        .modal-content textarea { width: 100%; height: 40vh; resize: none; font-family: monospace; font-size: 12px; margin-bottom: 10px; border-radius: 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { background-color: #000; color: #fff; }
        
        .hidden-input { display: none; }
    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <div class="top-input-row">
            <input type="text" id="object-name" placeholder="Enter object name here...">
            <button id="api-key-btn">Enter API-Key</button>
        </div>

        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
        </div>

        <div id="bottom-ui-container">
            <div class="icon-controls">
                <div id="upload-json-btn" class="icon-button" title="Upload a model from a JSON file"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload JSON</div></div>
                <div id="copy-json-btn" class="icon-button" title="View and copy the current model's JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy JSON</div></div>
                <div id="download-json-btn" class="icon-button" title="Download the current model as a JSON file"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download JSON</div></div>
            </div>
            
            <div class="action-buttons">
                <button id="add-files-btn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/></svg>Add Files</button>
                <button id="generate-model-btn" class="btn">Generate Model</button>
            </div>

            <div class="instructions-group">
                <label for="additional-instructions">Additional Instructions (Prompt by User, for example Changes to the model)...</label>
                <textarea id="additional-instructions"></textarea>
            </div>

            <div class="hans-group">
                <div id="hans-output"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals and Hidden Inputs -->
    <div id="json-modal-overlay" class="modal-overlay"><div class="modal-content"><h3>Current Model JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="api-key-modal-overlay" class="modal-overlay"><div class="modal-content"><h3>Enter Gemini API Key</h3><input type="password" id="api-key-input" placeholder="Your key is used locally and not stored" style="width: 100%; padding: 10px; border: 1px solid #000; border-radius: 0; box-sizing: border-box; margin-bottom: 10px;"><div class="modal-actions"><button id="save-api-key-btn" class="btn modal-btn">Save</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <input type="file" id="json-upload-input" class="hidden-input" accept=".json, .txt"><input type="file" id="add-files-input" class="hidden-input" multiple>

    <!-- Three.js Import -->
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls;
        let currentJsonData = null;
        let typingInterval;
        const objectGroup = new THREE.Group();
        const HANS_PREFIX = `HANSðŸ§ : `;

        const viewerContainer = document.getElementById('viewer-container');
        const viewerCanvas = document.getElementById('viewer-canvas');
        const hansOutputEl = document.getElementById('hans-output');

        function updateHANS(message) {
            // Stop any existing animation
            if (typingInterval) clearInterval(typingInterval);

            // Prepare elements
            hansOutputEl.innerHTML = `${HANS_PREFIX}<span id="hans-output-text"></span><span class="cursor"></span>`;
            const textEl = document.getElementById('hans-output-text');
            const cursorEl = hansOutputEl.querySelector('.cursor');
            
            let i = 0;
            typingInterval = setInterval(() => {
                if (i < message.length) {
                    textEl.textContent += message.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    cursorEl.style.display = 'none'; // Hide cursor when done
                }
            }, 30); // Typing speed in milliseconds
        }
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.add(objectGroup);

            camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000);
            camera.position.set(-1.1, 0.7, -1.1);
            
            renderer = new THREE.WebGLRenderer({ canvas: viewerCanvas, antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.4, 0);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight.position.set(2, 5, 3);
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize);
            
            loadDefaultCube();
            animate();
            updateHANS("Hello, this is HANS (Heuristic Agent for Narrating Structures). Let's think of a model.");
        }

        function clearModel() {
            while(objectGroup.children.length > 0){ objectGroup.remove(objectGroup.children[0]); }
        }

        function createModel(jsonData) {
            clearModel();
            
            let objectNameKey = Object.keys(jsonData).find(k => k.toLowerCase().includes('name'));
            let objectName = jsonData[objectNameKey] || 'Untitled';
            
            if (!jsonData || !jsonData.parts || !Array.isArray(jsonData.parts)) {
                updateHANS("Error: Could not parse the selected file. Is it a valid JSON?");
                return;
            }

            currentJsonData = jsonData;

            const material = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.5, polygonOffset: true, polygonOffsetFactor: 1, polygonOffsetUnits: 1 });
            const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8 });
            
            const bounds = new THREE.Box3().set(new THREE.Vector3(), new THREE.Vector3());

            jsonData.parts.forEach(part => {
                const dims = part.dimensions;
                const orig = part.origin;
                const geometry = new THREE.BoxGeometry(dims.width, dims.height, dims.depth);
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set( orig.x + dims.width / 2, orig.z + dims.height / 2, orig.y + dims.depth / 2 );
                objectGroup.add(mesh);
                bounds.expandByObject(mesh);

                const edges = new THREE.EdgesGeometry(geometry);
                const line = new THREE.LineSegments(edges, outlineMaterial);
                line.position.copy(mesh.position);
                objectGroup.add(line);
            });
            
            const center = new THREE.Vector3();
            bounds.getCenter(center);
            controls.target.copy(center);
            
            updateHANS(`Model "${objectName}" loaded with ${jsonData.parts.length} parts.`);
        }

        function loadDefaultCube() {
            document.getElementById('object-name').value = "";
            const cube = {
              "objectName": "Default Cube",
              "parts": [{ "origin": {"x": -0.25, "y": -0.25, "z": 0.0}, "dimensions": {"width": 0.5, "depth": 0.5, "height": 0.5} }]
            };
            createModel(cube);
        }

        function onWindowResize() {
            const width = viewerContainer.clientWidth;
            const height = viewerContainer.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- UI EVENT HANDLERS ---
        const uploadJsonInput = document.getElementById('json-upload-input');
        document.getElementById('upload-json-btn').addEventListener('click', () => uploadJsonInput.click());
        uploadJsonInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    let objectNameKey = Object.keys(jsonData).find(k => k.toLowerCase().includes('name'));
                    document.getElementById('object-name').value = jsonData[objectNameKey] || file.name.replace(/\.[^/.]+$/, "");
                    createModel(jsonData);
                } catch (error) {
                    updateHANS("Error: Could not parse the selected file. Is it a valid JSON?");
                    clearModel();
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        document.getElementById('download-json-btn').addEventListener('click', () => {
            if (!currentJsonData) { updateHANS("No model data to download."); return; }
            const objectName = document.getElementById('object-name').value.trim() || 'namelessObject';
            const downloadData = { ...currentJsonData };
            Object.keys(downloadData).forEach(key => { if (key.toLowerCase().includes('name') && key !== 'name') delete downloadData[key]; });
            const finalData = { "objectName": objectName, ...downloadData };
            const jsonString = JSON.stringify(finalData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${objectName.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            updateHANS("JSON download initiated.");
        });

        document.getElementById('copy-json-btn').addEventListener('click', () => {
             if (!currentJsonData) { updateHANS("No model data to show."); return; }
             document.getElementById('json-view-textarea').value = JSON.stringify(currentJsonData, null, 2);
             document.getElementById('json-modal-overlay').style.display = 'flex';
        });
        document.getElementById('api-key-btn').addEventListener('click', () => {
            document.getElementById('api-key-modal-overlay').style.display = 'flex';
        });
        document.getElementById('save-api-key-btn').addEventListener('click', () => {
             const key = document.getElementById('api-key-input').value;
             updateHANS(key ? "API Key has been set for this session." : "API Key cleared.");
             document.getElementById('api-key-modal-overlay').style.display = 'none';
        });
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => { e.target.closest('.modal-overlay').style.display = 'none'; });
        });
        document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('json-view-textarea').value).then(() => {
                updateHANS("JSON copied to clipboard.");
                document.getElementById('json-modal-overlay').style.display = 'none';
            }, () => { updateHANS("Failed to copy JSON."); });
        });
        
        document.getElementById('add-files-btn').addEventListener('click', () => {
            document.getElementById('add-files-input').click();
            updateHANS("Add Files: This feature is for UI demonstration.");
        });
        document.getElementById('generate-model-btn').addEventListener('click', () => {
            updateHANS("Generate Model: API connection is not yet implemented.");
        });
        
        // --- START ---
        init();
    </script>
</body>
</html>