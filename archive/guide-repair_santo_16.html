<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Step 4: Execute Plan</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #fff; color: #000; display: flex; justify-content: center; padding: 20px 0; }

        #app-wrapper { width: 90%; max-width: 420px; display: flex; flex-direction: column; gap: 20px; }
        #top-header { display: flex; flex-direction: column; gap: 20px; }
        .top-input-row { display: flex; align-items: stretch; gap: 10px; }
        #object-name { flex-grow: 1; background-color: #f0f0f0; padding: 12px; border: 1px solid #000; border-radius: 0; font-size: 14px; box-sizing: border-box; }

        #viewer-container { width: 100%; height: 40vh; position: relative; background-color: #fff; }
        #viewer-canvas { display: block; width: 100%; height: 100%; }
        #info-box { position: absolute; top: 10px; left: 0px; padding: 0px; background-color: transparent; border: none; font-family: monospace; font-size: 12px; line-height: 1.4; z-index: 101; display: none; pointer-events: none; max-width: 250px; }

        #step-display-container { display: none; position: absolute; top: 10px; right: 0px; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; }
        #step-counter { font-family: monospace; font-size: 12px; color: #d00; margin-bottom: 5px; }
        .step-nav-arrow { cursor: pointer; display: block; width: 30px; height: 30px; border: 1px solid #d00; color: #d00; background-color: #fff; text-align: center; line-height: 28px; font-size: 20px; margin-top: 5px; user-select: none; }
        .step-nav-arrow.disabled { cursor: not-allowed; color: #ccc; border-color: #ccc; }
        #step-info-panel { display: none; position: absolute; bottom: 10px; left: 0px; right: 0px; background-color: rgba(221, 51, 51, 0.85); color: #fff; padding: 15px; border: 1px solid #d00; cursor: pointer; z-index: 100; }
        #step-info-panel h4 { margin: 0 0 5px 0; font-size: 16px; font-weight: bold; text-align: center;  }
        #step-info-panel p { margin: 0; font-size: 12px; }
        #step-info-panel .click-prompt { font-size: 8px; text-transform: uppercase; margin-top: 8px; opacity: 0.8; text-align: center; }

        #step-info-panel.completed {
            background-color: rgba(25, 135, 84, 0.85);
            border-color: #198754;
        }

        #bottom-ui-container { display: flex; flex-direction: column; gap: 15px; }
        .icon-controls { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; }
        .icon-button { cursor: pointer; color: #000; }
        .icon-button svg { width: 18px; height: 18px; }
        .icon-button .label { font-size: 12px; margin-top: 5px; }

        .action-buttons { display: flex; gap: 10px; }
        .btn { flex-grow: 1; padding: 12px; font-size: 14px; font-weight: 600; border: none; border-radius: 0; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background-color: #0d6efd; color: #fff; }
        .btn-success { background-color: #198754; color: #fff; }
        .btn-dark { background-color: #000; color: #fff; }
        .btn.disabled { background-color: #ccc; cursor: not-allowed; border: 1px solid #bbb; }
        
        .instructions-group { background-color: #fff; padding: 15px; border: 1px solid #000; }
        .instructions-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #000; }
        .instructions-group textarea { width: 100%; height: 60px; padding: 10px; border: none; background-color: #fff; color: #000; border-radius: 0; font-size: 14px; box-sizing: border-box; resize: vertical; }

        .helga-group { background-color: #000; color: #fff; padding: 15px; }
        #helga-output { font-family: "SF Mono", Consolas, Menlo, monospace; font-size: 13px; line-height: 1.5; min-height: 20px; white-space: pre-wrap; }
        #helga-output .cursor { display: inline-block; background-color: #fff; width: 8px; height: 1em; animation: blink 1s step-end infinite; }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #fff; }
        }

        .modal-overlay, .modal-content, .modal-actions { box-sizing: border-box; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #fff; padding: 20px; border: 1px solid #000; width: 100%; max-width: 400px; display: flex; flex-direction: column; max-height: 80vh; }
        .modal-content h3 { margin-top: 0; color: #000; text-align: center; }
        .modal-body { overflow-y: auto; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn { background-color: #000; color: #fff; }
        .hidden-input { display: none; }
        #json-view-modal-overlay .modal-content textarea { width: 100%; height: 40vh; resize: none; font-family: monospace; font-size: 12px; margin-bottom: 10px; border-radius: 0; }
        #graph-modal-overlay .modal-content { max-width: 90vw; height: 80vh; }
        #graph-container { width: 100%; height: calc(100% - 40px); }
        #graph-container svg { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="top-header">
            <div class="top-input-row">
                <input type="text" id="object-name" placeholder="Enter object name..." readonly>
            </div>
        </div>

        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
            <div id="info-box"></div>
            
            <div id="step-display-container">
                <div id="step-counter"></div>
                <div id="step-nav-next" class="step-nav-arrow">‚Üí</div>
                <div id="step-nav-prev" class="step-nav-arrow">‚Üê</div>
            </div>
            <div id="step-info-panel">
                <h4 id="step-info-title"></h4>
                <div class="click-prompt">(Click for more information)</div>
            </div>
        </div>
        
        <div id="bottom-ui-container">
             <div class="icon-controls">
                <div id="upload-json-btn" class="icon-button" title="Upload JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload JSON</div></div>
                <div id="copy-json-btn" class="icon-button" title="Read & Copy JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy JSON</div></div>
                <div id="view-plan-graph-btn" class="icon-button" title="View plan graph"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><div class="label">View Graph</div></div>
                <div id="download-json-btn" class="icon-button" title="Download JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download JSON</div></div>
            </div>
            
            <div class="action-buttons">
                <button id="start-btn" class="btn btn-primary">‚è±Ô∏è Start</button>
                <button id="done-btn" class="btn btn-success">‚úÖ Done!</button>
                <button id="ask-question-btn" class="btn btn-dark">‚ùì Ask</button>
                <button id="comment-btn" class="btn btn-dark">üí¨ Comment</button>
            </div>

            <div class="instructions-group">
                <label for="user-prompt">Ask a question or add a comment about the current step...</label>
                <textarea id="user-prompt" placeholder="e.g., 'What is the best type of glue for this?' or 'Completed, but the fit is tight.'"></textarea>
            </div>

            <div class="helga-group">
                <div id="helga-output"></div>
            </div>
        </div>
    </div>
    
    <div id="data-choice-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="data-choice-title">Select Data</h3><div class="action-buttons" style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="choice-btn-assembly" class="btn modal-btn">üì¶ Assembly</button><button id="choice-btn-damages" class="btn modal-btn">üìç Damages</button><button id="choice-btn-plan" class="btn modal-btn">üìã Repair-Plan</button><button id="choice-btn-history" class="btn modal-btn">üìñ History</button></div><div class="modal-actions" style="margin-top:20px"><button class="btn modal-btn close-modal-btn">Cancel</button></div></div></div>
    <div id="json-view-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="json-view-title">Current JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="graph-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="graph-title">Graph</h3><div id="graph-container"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="step-detail-modal-overlay" class="modal-overlay"><div class="modal-content"><h3>Step Details</h3><div id="step-detail-modal-body" class="modal-body"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>

    <input type="file" id="assembly-upload-input" class="hidden-input" accept=".json">
    <input type="file" id="damages-upload-input" class="hidden-input" accept=".json">
    <input type="file" id="plan-upload-input" class="hidden-input" accept=".json">

    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@2.12.2/dist/graphviz.umd.js"></script>
    <script src="https://unpkg.com/d3-graphviz@5.1.0/build/d3-graphviz.js"></script>
    <script type="importmap">{"imports": {"three": "https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const HELGA_PREFIX = "H.E.L.G.A.üé≠: ";
        let scene, camera, renderer, controls, axesScene, axesCamera, infoBox, raycaster, mouse;
        let typingInterval;
        let currentModelJson, currentDamageJson, currentHistoryJson;
        let currentStepIndex = 0;
        let stepStartTime = null;

        const objectGroup = new THREE.Group();
        const damageSpheres = [];
        const partMeshesMap = new Map();
        
        const viewerContainer = document.getElementById('viewer-container');
        const viewerCanvas = document.getElementById('viewer-canvas');
        const helgaOutputEl = document.getElementById('helga-output');
        const userPromptInput = document.getElementById('user-prompt');
        const stepDisplayContainer = document.getElementById('step-display-container');
        const stepInfoPanel = document.getElementById('step-info-panel');
        const stepCounterEl = document.getElementById('step-counter');
        const stepNavNextBtn = document.getElementById('step-nav-next');
        const stepNavPrevBtn = document.getElementById('step-nav-prev');
        const startBtn = document.getElementById('start-btn');
        const doneBtn = document.getElementById('done-btn');

        const defaultPartMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const stepHighlightMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const selectionPartMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff, transparent: true, opacity: 0.8, side: THREE.DoubleSide });
        const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8});
        const defaultDotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const selectedDotMaterial = new THREE.MeshBasicMaterial({ color: 0x6f0000 });
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.add(objectGroup);
            camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000);
            camera.position.set(-1.0, 0.9, -1.2);
            renderer = new THREE.WebGLRenderer({ canvas: viewerCanvas, antialias: true, alpha: true });
            renderer.autoClear = false;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.4, 0);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8), new THREE.DirectionalLight(0xffffff, 0.7, 3));
            axesScene = new THREE.Scene();
            const gizmoSize = 2.5;
            axesCamera = new THREE.OrthographicCamera(-gizmoSize, gizmoSize, gizmoSize, -gizmoSize, -10, 10);
            const axes = new THREE.AxesHelper(1.5);
            axes.rotation.x = -Math.PI / 2;
            axesScene.add(axes);
            infoBox = document.getElementById('info-box');
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            setupEventListeners();
            loadDefaults();
            animate();
        }

        function loadDefaults() {
            const defaultModel = { "objectName": "santo_16", "description": "Chair model based on Dietiker SANTO product data sheet and iterative refinement. Origin at center of floor footprint.", "units": "meters", "overallDimensions": { "width_legs_bbox": 0.5, "depth_legs_bbox": 0.49, "total_height": 0.76 }, "parts": [ { "id": "front_left_leg", "name": "Front Left Leg", "type": "box", "origin": { "x": -0.25, "y": -0.245, "z": 0.008 }, "dimensions": { "width": 0.03, "depth": 0.045, "height": 0.426 }, "connections": [ "front_apron", "left_side_apron", "seat", "front_left_glider" ], "status": "intact" }, { "id": "front_right_leg", "name": "Front Right Leg", "type": "box", "origin": { "x": 0.22, "y": -0.245, "z": 0.008 }, "dimensions": { "width": 0.03, "depth": 0.045, "height": 0.426 }, "connections": [ "front_apron", "right_side_apron", "seat", "front_right_glider" ], "status": "intact" }, { "id": "back_left_leg", "name": "Back Left Leg", "type": "box", "origin": { "x": -0.25, "y": 0.2, "z": 0.008 }, "dimensions": { "width": 0.03, "depth": 0.045, "height": 0.752 }, "connections": [ "back_apron", "left_side_apron", "seat", "backrest", "back_left_glider" ], "status": "defective" }, { "id": "back_right_leg", "name": "Back Right Leg", "type": "box", "origin": { "x": 0.22, "y": 0.2, "z": 0.008 }, "dimensions": { "width": 0.03, "depth": 0.045, "height": 0.752 }, "connections": [ "back_apron", "right_side_apron", "seat", "backrest", "back_right_glider" ], "status": "defective" }, { "id": "front_apron", "name": "Front Apron", "type": "box", "origin": { "x": -0.22, "y": -0.245, "z": 0.374 }, "dimensions": { "width": 0.44, "depth": 0.027, "height": 0.06 }, "connections": [ "front_left_leg", "front_right_leg", "seat" ], "status": "intact" }, { "id": "back_apron", "name": "Back Apron", "type": "box", "origin": { "x": -0.22, "y": 0.218, "z": 0.374 }, "dimensions": { "width": 0.44, "depth": 0.027, "height": 0.06 }, "connections": [ "back_left_leg", "back_right_leg", "seat" ], "status": "intact" }, { "id": "left_side_apron", "name": "Left Side Apron", "type": "box", "origin": { "x": -0.22, "y": -0.218, "z": 0.374 }, "dimensions": { "width": 0.027, "depth": 0.436, "height": 0.06 }, "connections": [ "front_left_leg", "back_left_leg", "seat" ], "status": "intact" }, { "id": "right_side_apron", "name": "Right Side Apron", "type": "box", "origin": { "x": 0.193, "y": -0.218, "z": 0.374 }, "dimensions": { "width": 0.027, "depth": 0.436, "height": 0.06 }, "connections": [ "front_right_leg", "back_right_leg", "seat" ], "status": "defective" }, { "id": "seat", "name": "Seat", "type": "box", "origin": { "x": -0.22, "y": -0.245, "z": 0.434 }, "dimensions": { "width": 0.44, "depth": 0.49, "height": 0.006 }, "connections": [ "front_left_leg", "front_right_leg", "back_left_leg", "back_right_leg", "front_apron", "back_apron", "left_side_apron", "right_side_apron" ], "status": "defective" }, { "id": "backrest", "name": "Backrest", "type": "box", "origin": { "x": -0.22, "y": 0.2, "z": 0.65 }, "dimensions": { "width": 0.44, "depth": 0.05, "height": 0.11 }, "connections": [ "back_left_leg", "back_right_leg" ], "status": "defective" }, { "id": "front_left_glider", "name": "Front Left Glider", "type": "box", "origin": { "x": -0.2475, "y": -0.2425, "z": 0 }, "dimensions": { "width": 0.025, "depth": 0.04, "height": 0.008 }, "connections": [ "front_left_leg" ], "status": "intact" }, { "id": "front_right_glider", "name": "Front Right Glider", "type": "box", "origin": { "x": 0.2225, "y": -0.2425, "z": 0 }, "dimensions": { "width": 0.025, "depth": 0.04, "height": 0.008 }, "connections": [ "front_right_leg" ], "status": "intact" }, { "id": "back_left_glider", "name": "Back Left Glider", "type": "box", "origin": { "x": -0.2475, "y": 0.2025, "z": 0 }, "dimensions": { "width": 0.025, "depth": 0.04, "height": 0.008 }, "connections": [ "back_left_leg" ], "status": "intact" }, { "id": "back_right_glider", "name": "Back Right Glider", "type": "box", "origin": { "x": 0.2225, "y": 0.2025, "z": 0 }, "dimensions": { "width": 0.025, "depth": 0.04, "height": 0.008 }, "connections": [ "back_right_leg" ], "status": "intact" } ], "missingParts": [ {} ] };
            const defaultDamage = [ { "id": "damage_01", "type": "Crack", "description": "Severe Crack on the top of the back right leg at the joint.", "part_id": "back_right_leg", "coordinates": { "x": 0.235, "y": 0.2225, "z": 0.755 } }, { "id": "damage_02", "type": "Scuff Mark", "description": "Heavy scuff marks and wear along the back legs.", "part_id": "back_left_leg", "coordinates": { "x": -0.235, "y": 0.2225, "z": 0.38 } }, { "id": "damage_03", "type": "Scuff Mark", "description": "Heavy scuff marks and wear along the back legs.", "part_id": "back_right_leg", "coordinates": { "x": 0.235, "y": 0.2225, "z": 0.38 } }, { "id": "damage_04", "type": "Scratch", "description": "Faint scratch mark visible on the seat surface.", "part_id": "seat", "coordinates": { "x": 0, "y": 0, "z": 0.437 } }, { "id": "damage_05", "type": "Scratch", "description": "Long, horizontal deeo scratch on the front face of the backrest.", "part_id": "backrest", "coordinates": { "x": 0, "y": 0.2, "z": 0.7 } }, { "id": "damage_06", "type": "Chip", "description": "Minor chipping and wear on the top edge of the right side apron.", "part_id": "right_side_apron", "coordinates": { "x": 0.2065, "y": 0, "z": 0.434 } } ];
            const defaultPlan = { "steps": [ { "step_number": 1, "title": "Secure The Chair", "description": "Place the chair on a stable, flat surface. To prevent it from moving during the cutting process, either clamp the seat firmly to a workbench or have a second person stand on the seat with their full weight. Ensure the back of the chair hangs over the edge of the surface, providing clear access for the saw.", "tools_required": [ "Clamps" ], "affected_parts": [ "seat", "front_left_leg", "front_right_leg", "back_left_leg", "back_right_leg" ], "affected_damages": [] }, { "step_number": 2, "title": "Mark The Cut", "description": "Using a pencil and a straight edge, draw a clear, straight line across the back of both the 'back_left_leg' and 'back_right_leg'. The line should be perfectly level and positioned exactly where the top surface of the seat meets the legs. This line is your cutting guide to ensure a flat top for the new stool.", "tools_required": [ "Pencil", "Straight Edge" ], "affected_parts": [ "back_left_leg", "back_right_leg" ], "affected_damages": [] }, { "step_number": 3, "title": "Cut Off Back Assembly", "description": "Put on your safety goggles. Brace the foot of the reciprocating saw firmly against the 'back_left_leg'. Start the saw slowly and once the blade bites into the wood, increase to full speed, following the marked line precisely. Repeat the exact same process for the 'back_right_leg'. The entire back assembly will detach and can be set aside for disposal. This single action permanently removes the cracked, scratched, and scuffed back half of the chair.", "tools_required": [ "Reciprocating Saw", "Safety Goggles" ], "affected_parts": [ "backrest", "back_left_leg", "back_right_leg" ], "affected_damages": [ "damage_01", "damage_02", "damage_03", "damage_05" ] }, { "step_number": 4, "title": "Sand The Fresh Cuts", "description": "Take the orbital sander with medium-grit sandpaper and smooth the two fresh cut surfaces on top of the remaining back leg stumps. The goal is to remove any large splinters and slightly round over the sharp edges to prevent snagging. The surface does not need to be perfectly smooth, just safe to the touch.", "tools_required": [ "Orbital Sander", "Medium-Grit Sandpaper" ], "affected_parts": [ "back_left_leg", "back_right_leg" ], "affected_damages": [] }, { "step_number": 5, "title": "Smooth Remaining Damage", "description": "Using the same orbital sander, quickly go over the scratched seat surface and the chipped area on the 'right_side_apron'. Apply light pressure and keep the sander moving. This is not for looks, but to knock down any rough patches and prepare the surface for a thick coat of paint.", "tools_required": [ "Orbital Sander", "Medium-Grit Sandpaper" ], "affected_parts": [ "seat", "right_side_apron" ], "affected_damages": [ "damage_04", "damage_06" ] }, { "step_number": 6, "title": "Clean For Painting", "description": "Thoroughly wipe down the entire stool with a clean, dry cloth to remove every particle of sanding dust. Dust is the enemy of a good finish, even a durable one. Pay special attention to corners and joints where dust can accumulate.", "tools_required": [ "Cleaning Cloth" ], "affected_parts": [ "seat", "front_left_leg", "front_right_leg", "back_left_leg", "back_right_leg", "front_apron", "back_apron", "left_side_apron", "right_side_apron" ], "affected_damages": [] }, { "step_number": 7, "title": "Prepare Paint Area", "description": "Move the stool to a well-ventilated area, preferably outdoors or in a large open room. Lay down cardboard or newspaper to protect the floor from overspray. Shake the can of industrial enamel spray paint vigorously for at least one full minute to mix the contents properly.", "tools_required": [ "Cardboard or Newspaper" ], "affected_parts": [], "affected_damages": [] }, { "step_number": 8, "title": "Apply Durable Enamel", "description": "Hold the spray can about 8-10 inches from the surface. Start spraying just off the edge of the stool, move across the surface in a steady, sweeping motion, and stop spraying after you've passed the opposite edge. Overlap each pass by about 50%. Apply one single, thick, wet coat to all visible surfaces to create a tough, protective shell. Let it dry to the touch.", "tools_required": [ "Industrial Enamel Spray Paint" ], "affected_parts": [ "seat", "front_left_leg", "front_right_leg", "back_left_leg", "back_right_leg", "front_apron", "back_apron", "left_side_apron", "right_side_apron" ], "affected_damages": [] }, { "step_number": 9, "title": "Remove Old Feet", "description": "Once the paint is no longer tacky, carefully flip the stool upside down. Wedge a pry bar or the claw of a hammer under the edge of each of the four old gliders. Apply firm, steady pressure to lever them off and pull out the nail. Discard the old gliders.", "tools_required": [ "Pry Bar" ], "affected_parts": [ "front_left_glider", "front_right_glider", "back_left_glider", "back_right_glider" ], "affected_damages": [] }, { "step_number": 10, "title": "Install New Feet", "description": "Position a new heavy-duty, nail-on glider in the center of the bottom of a leg. Hold it steady with one hand and give it a few firm, direct taps with a hammer until it is fully seated and flush against the leg. Repeat for the other three legs. This upgrade provides superior stability and floor protection.", "tools_required": [ "Hammer", "4x Heavy-Duty Nail-On Glides" ], "affected_parts": [ "front_left_leg", "front_right_leg", "back_left_leg", "back_right_leg" ], "affected_damages": [] }, { "step_number": 11, "title": "Final Inspection", "description": "Flip the stool upright. Check that it sits level and does not wobble. The conversion is complete. The stool is now far more robust and easier to maintain than the original chair and is ready for immediate, heavy use.", "tools_required": [], "affected_parts": [], "affected_damages": [] } ] };
            
            createModel(defaultModel);
            createDamages(defaultDamage);
            initializeHistory(defaultPlan);
            updateHELGA(`Repair plan for '${defaultModel.objectName}' loaded with ${defaultPlan.steps.length} steps. Click 'Start' on Step 1 to begin.`);
            displayCurrentStep();
        }
        
        function initializeHistory(planJson) {
            currentHistoryJson = JSON.parse(JSON.stringify(planJson)); 
            currentHistoryJson.steps.forEach(step => {
                step.completed = false;
                step.time_minutes = 0;
                step.comments = step.comments || "";
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.clear();
            renderer.render(scene, camera);
            renderer.clearDepth();
            const gizmoSize = 80;
            renderer.setViewport(10, 10, gizmoSize, gizmoSize);
            axesCamera.quaternion.copy(camera.quaternion);
            renderer.render(axesScene, axesCamera);
            renderer.setViewport(0, 0, renderer.domElement.clientWidth, renderer.domElement.clientHeight);
        }

        function onWindowResize() {
            const w = viewerContainer.clientWidth, h = viewerContainer.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }

        function saveCurrentComment() {
            if (!currentHistoryJson || !currentHistoryJson.steps[currentStepIndex]) return;
            const step = currentHistoryJson.steps[currentStepIndex];
            step.comments = userPromptInput.value.trim();
        }

        function displayCurrentStep() {
            if (!currentHistoryJson || !currentHistoryJson.steps || currentHistoryJson.steps.length === 0) {
                stepDisplayContainer.style.display = 'none';
                stepInfoPanel.style.display = 'none';
                return;
            }

            stepDisplayContainer.style.display = 'flex';
            stepInfoPanel.style.display = 'block';
            const step = currentHistoryJson.steps[currentStepIndex];
            if (!step) return;

            stepInfoPanel.classList.toggle('completed', step.completed);
            stepCounterEl.textContent = `Current Step: Nr. ${step.step_number}`;
            document.getElementById('step-info-title').textContent = step.title + (step.completed ? ' (Done)' : '');
            userPromptInput.value = step.comments || '';
            stepNavPrevBtn.classList.toggle('disabled', currentStepIndex === 0);
            stepNavNextBtn.classList.toggle('disabled', currentStepIndex === currentHistoryJson.steps.length - 1);
            highlightElements(step.affected_parts || [], step.affected_damages || [], stepHighlightMaterial);
            updateButtonStates();
        }

        function updateButtonStates() {
            if (!currentHistoryJson) return;
            const step = currentHistoryJson.steps[currentStepIndex];
            startBtn.classList.toggle('disabled', step.completed || !!stepStartTime);
            doneBtn.classList.toggle('disabled', step.completed || !stepStartTime);
        }

        function createModel(jsonData) {
            while (objectGroup.children.length > 0) objectGroup.remove(objectGroup.children[0]);
            partMeshesMap.clear();
            currentModelJson = jsonData;
            document.getElementById('object-name').value = jsonData.objectName || "Untitled";
            const bounds = new THREE.Box3();
            jsonData.parts.forEach(part => {
                const geo = new THREE.BoxGeometry(part.dimensions.width, part.dimensions.height, part.dimensions.depth);
                const pos = new THREE.Vector3(part.origin.x + part.dimensions.width/2, part.origin.z + part.dimensions.height/2, part.origin.y + part.dimensions.depth/2);
                const mesh = new THREE.Mesh(geo, defaultPartMaterial);
                mesh.position.copy(pos);
                mesh.userData.part = part;
                objectGroup.add(mesh);
                const line = new THREE.LineSegments(new THREE.EdgesGeometry(geo), outlineMaterial);
                line.position.copy(pos);
                objectGroup.add(line);
                partMeshesMap.set(part.id, mesh);
            });
            bounds.setFromObject(objectGroup);
            const center = new THREE.Vector3();
            bounds.getCenter(center);
            controls.target.copy(center);
        }

        function createDamages(jsonData) {
            damageSpheres.forEach(s => scene.remove(s));
            damageSpheres.length = 0;
            if(!currentModelJson) { updateHELGA("Error: Please load an assembly file first."); return; }
            currentDamageJson = jsonData;
            const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16);
            jsonData.forEach(damage => {
                const sphere = new THREE.Mesh(dotGeometry, defaultDotMaterial.clone());
                sphere.position.set(damage.coordinates.x, damage.coordinates.z, damage.coordinates.y);
                sphere.userData.damage = damage;
                damageSpheres.push(sphere);
                scene.add(sphere);
            });
        }
        
        function updateHELGA(message, isTyping = false, duration = 0) {
            if (typingInterval) clearInterval(typingInterval);
            if (isTyping) {
                 helgaOutputEl.innerHTML = `${HELGA_PREFIX}${message}`;
            } else if (duration > 0) {
                helgaOutputEl.innerHTML = `${HELGA_PREFIX}${message} (${duration.toFixed(2)} mins)`;
            } else {
                helgaOutputEl.innerHTML = `${HELGA_PREFIX}<span id="helga-text"></span><span class="cursor"></span>`;
                const textEl = document.getElementById('helga-text');
                const cursorEl = helgaOutputEl.querySelector('.cursor');
                if (!textEl || !cursorEl) return;
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < message.length) {
                        textEl.textContent += message.charAt(i++);
                    } else {
                        clearInterval(typingInterval);
                        if (cursorEl) cursorEl.style.display = 'none';
                    }
                }, 20);
            }
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (type === 'assembly') {
                        createModel(data);
                        updateHELGA("Assembly loaded. Please upload damages and a plan.");
                    } else if (type === 'damages') {
                        createDamages(data);
                        updateHELGA("Damages loaded. Please upload a plan.");
                    } else if (type === 'plan') {
                        initializeHistory(data);
                        currentStepIndex = 0;
                        displayCurrentStep();
                        updateHELGA(`Plan loaded with ${data.steps.length} steps. You can now start the repair.`);
                    }
                } catch (err) {
                    updateHELGA(`Error parsing ${type} file: ${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function viewJson(type) {
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentHistoryJson, history: currentHistoryJson };
            if (!dataMap[type]) { updateHELGA(`No ${type} data loaded.`); return; }
            document.getElementById('json-view-title').textContent = `Current ${type} JSON`;
            document.getElementById('json-view-textarea').value = JSON.stringify(dataMap[type], null, 2);
            document.getElementById('json-view-modal-overlay').style.display = 'flex';
        }

        function downloadJson(type) {
            saveCurrentComment();
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentHistoryJson, history: currentHistoryJson };
            if (!dataMap[type]) { updateHELGA(`No ${type} data loaded.`); return; }
            const name = (document.getElementById('object-name').value || 'object').replace(/\s+/g, '_');
            const blob = new Blob([JSON.stringify(dataMap[type], null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${name}_${type}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function highlightElements(partsToHighlight = [], damagesToHighlight = [], material) {
            partMeshesMap.forEach(mesh => { mesh.material = defaultPartMaterial; });
            damageSpheres.forEach(sphere => { sphere.material = defaultDotMaterial; });
            damagesToHighlight.forEach(damageId => {
                const sphere = damageSpheres.find(s => s.userData.damage.id === damageId);
                if (sphere) sphere.material = selectedDotMaterial;
            });
            partsToHighlight.forEach(partId => {
                const mesh = partMeshesMap.get(partId);
                if (mesh) mesh.material = material;
            });
        }

        function onObjectClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const sphereIntersects = raycaster.intersectObjects(damageSpheres);
            const partIntersects = raycaster.intersectObjects(Array.from(partMeshesMap.values()));
            
            const step = currentHistoryJson?.steps?.[currentStepIndex];
            if (step) {
                highlightElements(step.affected_parts || [], step.affected_damages || [], stepHighlightMaterial);
            }

            infoBox.style.display = 'none';
            
            if (sphereIntersects.length > 0) {
                const clickedSphere = sphereIntersects[0].object;
                const damageInfo = clickedSphere.userData.damage;
                clickedSphere.material = selectedDotMaterial;
                infoBox.style.color = '#ff0000';
                infoBox.innerHTML = `<b>${damageInfo.type} (${damageInfo.id}):</b><br>${damageInfo.description} Part: ${damageInfo.part_id}.`;
                infoBox.style.display = 'block';

            } else if (partIntersects.length > 0) {
                const clickedPart = partIntersects[0].object;
                const partData = clickedPart.userData.part;
                clickedPart.material = selectionPartMaterial;
                if (partData) {
                    const d = partData.dimensions;
                    infoBox.style.color = '#0000ff';
                    infoBox.innerHTML = `<b>Part:</b> ${partData.id.replace(/_/g, ' ')}<br><b>Size:</b> ${(d.width*100).toFixed(1)} x ${(d.depth*100).toFixed(1)} x ${(d.height*100).toFixed(1)} cm`;
                    infoBox.style.display = 'block';
                }
            }
        }

function viewGraph() {
            if (!currentHistoryJson || !currentHistoryJson.steps || currentHistoryJson.steps.length === 0) {
                updateHELGA("Load a repair plan to see its graph.");
                return;
            }

            const objectId = (currentModelJson?.objectName || 'object').replace(/\s+/g, '_');
            const steps = currentHistoryJson.steps; 
            const currentStepNumber = steps[currentStepIndex]?.step_number;

            const removeKeywords = ['remove', 'unscrew', 'detach', 'disassemble', 'pry', 'take off', 'unclip', 'sand', 'cut', 'unfasten', 'separate', 'take out', 'disconnect'];
            const addKeywords = ['add', 'apply', 'install', 'attach', 'secure', 'clamp', 'glue', 'insert', 'place', 'reassemble', 'fill', 'coat'];
            
            let dot = `digraph RepairPlan {\n  rankdir=LR;\n  node [fontname="Helvetica,Arial,sans-serif", fixedsize=true, width=1.6, height=1.2];\n  edge [fontname="Helvetica,Arial,sans-serif"];\n\n`;

            steps.forEach(step => {
                const label = step.title.replace(/\s+/g, '\\n');
                const nodeId = `${objectId}-S${step.step_number}`;
                const titleLower = step.title.toLowerCase();
                
                let attributes = [];
                let styleProperties = ['filled']; 

                let shape = 'circle';
                if (removeKeywords.some(kw => titleLower.includes(kw))) {
                    shape = 'doublecircle';
                    styleProperties.push('dashed');
                } else if (addKeywords.some(kw => titleLower.includes(kw))) {
                    shape = 'doublecircle';
                }
                attributes.push(`shape=${shape}`);
                
                if (step.completed) {
                    attributes.push(`fillcolor="#198754"`);
                    attributes.push('fontcolor=white');
                } else if (step.step_number === currentStepNumber) {
                    attributes.push(`fillcolor="#dd3333"`);
                    attributes.push('fontcolor=white');
                } else if (step.step_number === 1 || step.step_number === steps.length) {
                    styleProperties.push('filled');
                    attributes.push('fillcolor=black');
                    attributes.push('fontcolor=white');
                } else {
                    attributes.push(`fillcolor="white"`);
                    attributes.push('fontcolor=black');
                }

                attributes.push(`style="${styleProperties.join(',')}"`);
                
                dot += `  "${nodeId}" [label="${label}", ${attributes.join(', ')}];\n`;
            });

            for (let i = 0; i < steps.length - 1; i++) {
                dot += `  "${objectId}-S${steps[i].step_number}" -> "${objectId}-S${steps[i+1].step_number}";\n`;
            }
            dot += '}';

            document.getElementById('graph-title').textContent = "Repair Plan Graph";
            d3.select("#graph-container").graphviz({ useWorker: false }).renderDot(dot);
            document.getElementById('graph-modal-overlay').style.display = 'flex';
        }

        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            viewerCanvas.addEventListener('click', onObjectClick);

            startBtn.addEventListener('click', () => {
                if (startBtn.classList.contains('disabled')) return;
                stepStartTime = new Date();
                updateButtonStates();
                updateHELGA("Timer started for the current step.");
            });

            doneBtn.addEventListener('click', () => {
                if (doneBtn.classList.contains('disabled') || !stepStartTime) return;
                const durationMinutes = (new Date() - stepStartTime) / 60000;
                const step = currentHistoryJson.steps[currentStepIndex];
                step.completed = true;
                step.time_minutes = parseFloat(durationMinutes.toFixed(2));
                saveCurrentComment();
                stepStartTime = null;
                displayCurrentStep();
                updateHELGA(`Step ${step.step_number} completed! Time taken:`, false, durationMinutes);
            });

            document.getElementById('ask-question-btn').addEventListener('click', async () => {
                const question = userPromptInput.value.trim();
                if (!question) { updateHELGA("Please type a question in the text area first."); return; }
                if (!currentHistoryJson) { updateHELGA("Please load a plan first."); return; }
                const currentStep = currentHistoryJson.steps[currentStepIndex];
                updateHELGA("Thinking...", true);
                try {
                    const response = await fetch('/api/guide-repair', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question, stepContext: currentStep })
                    });
                    if (!response.ok) {
                        let errorMsg = `Server error ${response.status}. Check API file name and location.`;
                        try { errorMsg = (await response.json()).message || errorMsg; } catch (e) {}
                        throw new Error(errorMsg);
                    }
                    const result = await response.json();
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        throw new Error(result.candidates?.[0]?.finishReason === "SAFETY" ? "Request blocked for safety reasons." : "Invalid API response.");
                    }
                    updateHELGA(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.error("Ask H.E.L.G.A. Error:", error);
                    updateHELGA(`Sorry, an error occurred: ${error.message}`);
                }
            });

            document.getElementById('comment-btn').addEventListener('click', () => {
                 if (!currentHistoryJson) { updateHELGA("Please load a plan first."); return; }
                 saveCurrentComment();
                 updateHELGA("Your comment has been saved to the history file for this step.");
            });
            
            let currentAction = '';
            document.querySelectorAll('[id$="-json-btn"]').forEach(btn => btn.addEventListener('click', () => {
                const action = btn.id.split('-')[0]; // upload, copy, download
                currentAction = action;
                document.getElementById('data-choice-title').textContent = `What to ${action}?`;
                document.getElementById('data-choice-modal-overlay').style.display = 'flex';
            }));
            
            document.getElementById('view-plan-graph-btn').addEventListener('click', viewGraph);

            document.getElementById('choice-btn-assembly').addEventListener('click', () => handleChoice('assembly'));
            document.getElementById('choice-btn-damages').addEventListener('click', () => handleChoice('damages'));
            document.getElementById('choice-btn-plan').addEventListener('click', () => handleChoice('plan'));
            document.getElementById('choice-btn-history').addEventListener('click', () => handleChoice('history'));

            function handleChoice(type) {
                const actions = {
                    upload: () => document.getElementById(`${type}-upload-input`).click(),
                    copy: () => viewJson(type),
                    download: () => downloadJson(type)
                };
                actions[currentAction]?.();
                document.getElementById('data-choice-modal-overlay').style.display = 'none';
            }

            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', e => e.target.closest('.modal-overlay').style.display = 'none'));
            document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('json-view-textarea').value);
                updateHELGA("JSON copied to clipboard.");
                document.getElementById('json-view-modal-overlay').style.display = 'none';
            });

            stepNavNextBtn.addEventListener('click', () => navigateSteps(1));
            stepNavPrevBtn.addEventListener('click', () => navigateSteps(-1));

            function navigateSteps(direction) {
                saveCurrentComment();
                const newIndex = currentStepIndex + direction;
                if (newIndex >= 0 && newIndex < currentHistoryJson.steps.length) {
                    currentStepIndex = newIndex;
                    displayCurrentStep();
                }
            }
            
            stepInfoPanel.addEventListener('click', () => {
                if (!currentHistoryJson || !currentHistoryJson.steps) return;
                const step = currentHistoryJson.steps[currentStepIndex];
                if (!step) return;
                const body = document.getElementById('step-detail-modal-body');
                body.innerHTML = `<p>${step.description}</p><b>Tools:</b><ul>${(step.tools_required||[]).map(t=>`<li>${t}</li>`).join('')}</ul>`;
                document.getElementById('step-detail-modal-overlay').style.display = 'flex';
            });

            document.getElementById('assembly-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'assembly'));
            document.getElementById('damages-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'damages'));
            document.getElementById('plan-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'plan'));
        }
        
        init();
    </script>
</body>
</html>