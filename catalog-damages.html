<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Step 2: Catalog Damages</title>
    <!-- CSS is the same as the previous step with the corrected viewer -->
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background-color:#fff;color:#000;display:flex;justify-content:center;padding:20px 0}#app-wrapper{width:90%;max-width:420px;display:flex;flex-direction:column;gap:20px}#top-header {display: flex; flex-direction: column; gap: 20px;}.top-input-row{display:flex;align-items:stretch;gap:10px}#object-name{flex-grow:1;background-color:#f0f0f0;padding:12px;border:1px solid #000;border-radius:0;font-size:14px;box-sizing:border-box}#viewer-container{width:100%;height:40vh;position:relative;background-color:#fff;}#viewer-canvas{display:block;width:100%;height:100%}#bottom-ui-container{display:flex;flex-direction:column;gap:15px}.icon-controls{display:flex;justify-content:space-around;text-align:center;padding:10px 0}.icon-button{cursor:pointer;color:#000}.icon-button svg{width:18px;height:18px}.icon-button .label{font-size:12px;margin-top:5px}.action-buttons{display:flex;gap:10px}.btn{flex-grow:1;padding:12px;font-size:14px;font-weight:600;border:none;border-radius:0;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px;background-color:#000;color:#fff}.instructions-group{background-color:#fff;padding:15px;border:1px solid #000}.instructions-group label{display:block;font-size:12px;font-weight:600;margin-bottom:8px;color:#000}.instructions-group textarea{width:100%;height:60px;padding:10px;border:none;background-color:#fff;color:#000;border-radius:0;font-size:14px;box-sizing:border-box;resize:vertical}.MIA-group{background-color:#000;color:#fff;padding:15px}#MIA-output{font-family:"SF Mono",Consolas,Menlo,monospace;font-size:13px;line-height:1.5;min-height:20px}#MIA-output-text{white-space:pre-wrap}.cursor{display:inline-block;background-color:#fff;width:8px;height:1em;animation:blink 1s step-end infinite}@keyframes blink{from,to{background-color:transparent}50%{background-color:#fff}}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center;padding:20px;box-sizing:border-box}.modal-content{background-color:#fff;padding:20px;border-radius:0;border:1px solid #000;width:100%;max-width:600px;display:flex;flex-direction:column}.modal-content h3{margin-top:0;color:#000}.modal-content textarea{width:100%;height:40vh;resize:none;font-family:monospace;font-size:12px;margin-bottom:10px;border-radius:0}.modal-actions{display:flex;justify-content:flex-end;gap:10px}.modal-btn{background-color:#000;color:#fff}.hidden-input{display:none} a{color:#000; text-decoration: none;}
        #info-box { position: absolute; top: 10px; left: 0px; padding: 0; background-color: transparent; border: none; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 13px; line-height: 1.4; z-index: 101; display: none; pointer-events: none; text-shadow: none; max-width: 250px; }
        #graph-modal-overlay .modal-content { max-width: 90vw; height: 80vh; }
        #graph-container { width: 100%; height: calc(100% - 40px); }
        #graph-container svg { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="top-header">
             <!-- <a href="startseite.html" style="text-align: center;">&larr; Back to Workflow Overview</a> -->
            <div class="top-input-row">
                <input type="text" id="object-name" placeholder="Object name appears here..." readonly>
            </div>
        </div>
        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
            <div id="info-box"></div>
        </div>
        <div id="bottom-ui-container">
             <div class="icon-controls"><div id="upload-json-btn" class="icon-button" title="Upload a model or damage file"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload JSON</div></div><div id="copy-json-btn" class="icon-button" title="View and copy model or damage JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy JSON</div></div><div id="view-graph-btn" class="icon-button" title="View connection graph"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><div class="label">View Graph</div></div><div id="download-json-btn" class="icon-button" title="Download model or damage JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download JSON</div></div></div><div class="action-buttons"><button id="add-files-btn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/></svg>Add Damage Photos</button><button id="catalog-damages-btn" class="btn">Catalog Damages</button></div><div class="instructions-group"><label for="additional-instructions">Describe Damages (optional, use with photos for better results)...</label><textarea id="additional-instructions"></textarea></div><div class="MIA-group"><div id="MIA-output"></div></div>
        </div>
    </div>
    
    <div id="data-choice-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="data-choice-title">Select Data Type</h3><div class="action-buttons"><button id="choice-btn-model" class="btn modal-btn">üì¶ Assembly Geometry</button><button id="choice-btn-damages" class="btn modal-btn">üìç Damage Data</button></div><div class="modal-actions" style="margin-top: 20px;"><button class="btn modal-btn close-modal-btn">Cancel</button></div></div></div>
    <div id="json-view-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="json-view-title">Current JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    
    <div id="graph-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3>Assembly Connection Graph</h3>
            <div id="graph-container"></div>
            <div class="modal-actions">
                <button class="btn modal-btn close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="model-upload-input" class="hidden-input" accept=".json, .txt"><input type="file" id="damages-upload-input" class="hidden-input" accept=".json, .txt"><input type="file" id="add-files-input" class="hidden-input" multiple accept="image/*">

    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@2.12.2/dist/graphviz.umd.js"></script>
    <script src="https://unpkg.com/d3-graphviz@5.1.0/build/d3-graphviz.js"></script>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls, infoBox;
        let currentModelJson = null;
        let currentDamageJson = null;
        let uploadedFiles = [];
        let typingInterval;
        let damageSpheres = [];
        const objectGroup = new THREE.Group();
        const MIA_PREFIX = `M.I.A.üîç: `;
        let axesScene, axesCamera;
        let raycaster, mouse;
        const partMeshesMap = new Map();

        // --- Materials ---
        const intactPartMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.5 }); // Grey
        const defectivePartMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.7 }); // Red
        const missingPartMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00, transparent: true, opacity: 0.7 }); // Yellow
        const selectionPartMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff, transparent: true, opacity: 0.9 });
        const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8 });
        const defaultDotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const selectedDotMaterial = new THREE.MeshBasicMaterial({ color: 0x8b0000 });

        const viewerContainer = document.getElementById('viewer-container');
        const viewerCanvas = document.getElementById('viewer-canvas');
        const MIAOutputEl = document.getElementById('MIA-output');
        const modelUploadInput = document.getElementById('model-upload-input');
        const damagesUploadInput = document.getElementById('damages-upload-input');
        const addFilesInput = document.getElementById('add-files-input');
        infoBox = document.getElementById('info-box');
        
        function createDamageDots(damageData) {
            clearDamages();
            if (!Array.isArray(damageData)) {
                console.error("Invalid Damage Data received:", damageData);
                return;
            }
            currentDamageJson = damageData;
            const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16);
            
            damageData.forEach(damage => {
                if (!damage.coordinates || typeof damage.coordinates.x !== 'number') return;
                const sphere = new THREE.Mesh(dotGeometry, defaultDotMaterial.clone());
                sphere.position.set(damage.coordinates.x, damage.coordinates.z, damage.coordinates.y);
                sphere.userData.damage = damage;
                damageSpheres.push(sphere);
                scene.add(sphere);
            });
        }
        
        document.getElementById('catalog-damages-btn').addEventListener('click', async () => {
            if (!currentModelJson) {
                updateMIA("Please upload an assembly geometry JSON before cataloging damages.");
                return;
            }
            const promptText = document.getElementById('additional-instructions').value.trim();
            if (uploadedFiles.length === 0 && !promptText) {
                updateMIA("Please add damage photos or describe the new damage/status.");
                return;
            }
            updateMIA("AI is analyzing the assembly status... this may take a moment.");
            try {
                const payload = {
                    prompt: promptText,
                    modelJson: currentModelJson,
                    damageJson: currentDamageJson || [],
                    files: uploadedFiles
                };
                
                const response = await fetch('/api/catalog-damages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || JSON.stringify(errorResult));
                }

                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                     throw new Error("Invalid response structure from the API.");
                }

                const geminiResponseText = result.candidates[0].content.parts[0].text;
                const cleanedJsonString = geminiResponseText.replace(/```json\n|```/g, '').trim();
                const fullResponse = JSON.parse(cleanedJsonString);

                if (!fullResponse.updatedModel || !fullResponse.updatedDamages) {
                    throw new Error("API response is missing 'updatedModel' or 'updatedDamages'.");
                }
                
                // Re-create the model with the new statuses
                createModel(fullResponse.updatedModel);
                // Re-create the damage dots with the updated list
                createDamageDots(fullResponse.updatedDamages);
                
                uploadedFiles = [];
                document.getElementById('additional-instructions').value = '';

            } catch (error) {
                console.error("Damage Cataloging Error:", error);
                updateMIA(`Sorry, an error occurred: ${error.message}`);
            }
        });
        
        function updateMIA(message) { if (typingInterval) clearInterval(typingInterval); MIAOutputEl.innerHTML = `${MIA_PREFIX}<span id="MIA-output-text"></span><span class="cursor"></span>`; const textEl = document.getElementById('MIA-output-text'); const cursorEl = MIAOutputEl.querySelector('.cursor'); let i = 0; typingInterval = setInterval(() => { if (i < message.length) { textEl.innerHTML += message.charAt(i); i++; } else { clearInterval(typingInterval); if (cursorEl) cursorEl.style.display = 'none'; } }, 30); }
        
        function loadDefaultCubeAndDamage() {
             const defaultModel = {
                "objectName": "Default Cube",
                "parts": [{
                    "id": "cube",
                    "name": "The Cube",
                    "origin": { "x": -0.25, "y": -0.25, "z": 0.0 },
                    "dimensions": { "width": 0.5, "depth": 0.5, "height": 0.5 },
                    "connections": [],
                    "status": "intact" // Add initial status
                }]
            };
            createModel(defaultModel);
            createDamageDots([]); // Start with no damages
            updateMIA("Loaded a default cube. You can now describe damages or missing parts.");
        }
        
        function init() { scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff); scene.add(objectGroup); camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000); camera.position.set(-1.1, 0.7, -1.1); renderer = new THREE.WebGLRenderer({ canvas: viewerCanvas, antialias: true, alpha: true }); renderer.autoClear = false; renderer.setPixelRatio(window.devicePixelRatio); renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight); controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.target.set(0, 0.4, 0); const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7); directionalLight.position.set(2, 5, 3); scene.add(directionalLight); axesScene = new THREE.Scene(); const gizmoSize = 2.5; axesCamera = new THREE.OrthographicCamera(-gizmoSize, gizmoSize, gizmoSize, -gizmoSize, -10, 10); const axes = new THREE.AxesHelper(1.5); axes.rotation.x = -Math.PI / 2; axesScene.add(axes); raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2(); window.addEventListener('resize', onWindowResize); viewerCanvas.addEventListener('click', onObjectClick); animate(); loadDefaultCubeAndDamage(); }
        function onWindowResize() { const width = viewerContainer.clientWidth; const height = viewerContainer.clientHeight; camera.aspect = width / height; camera.updateProjectionMatrix(); renderer.setSize(width, height); }
        function animate() { requestAnimationFrame(animate); controls.update(); const time = Date.now() * 0.008; const scale = 1 + Math.sin(time) * 0.1; damageSpheres.forEach(sphere => { sphere.scale.set(scale, scale, scale); }); renderer.clear(); renderer.render(scene, camera); renderer.clearDepth(); const gizmoViewportSize = 80; renderer.setViewport(10, 10, gizmoViewportSize, gizmoViewportSize); axesCamera.quaternion.copy(camera.quaternion); renderer.render(axesScene, axesCamera); renderer.setViewport(0, 0, viewerContainer.clientWidth, viewerContainer.clientHeight); }
        function clearModel() { while(objectGroup.children.length > 0){ objectGroup.remove(objectGroup.children[0]); } partMeshesMap.clear(); }
        function clearDamages() { damageSpheres.forEach(sphere => scene.remove(sphere)); damageSpheres = []; currentDamageJson = null; }
        
        function resetAllMaterials() {
            if (!currentModelJson) return;

            partMeshesMap.forEach((mesh, partId) => {
                const partData = mesh.userData.part;
                switch (partData.status) {
                    case 'missing':
                        mesh.material = missingPartMaterial; // Yellow
                        break;
                    case 'defective':
                        mesh.material = defectivePartMaterial; // Red
                        break;
                    case 'intact':
                    default: // Fallback for parts with no status or 'intact'
                        mesh.material = intactPartMaterial; // Grey
                }
            });

            damageSpheres.forEach(sphere => {
                sphere.material = defaultDotMaterial;
            });
        }

        function createModel(jsonData) { 
            clearModel(); 
            let objectName = jsonData.objectName || 'Untitled'; 
            if (!jsonData || !jsonData.parts || !Array.isArray(jsonData.parts)) { 
                updateMIA("Error: Could not parse assembly file. Is it valid JSON?"); 
                return; 
            } 
            currentModelJson = jsonData; 
            document.getElementById('object-name').value = objectName; 
            
            const missingPartNames = [];
            const bounds = new THREE.Box3().set(new THREE.Vector3(), new THREE.Vector3()); 
            
            jsonData.parts.forEach(part => { 
                if (part.status === 'missing') {
                    missingPartNames.push(part.name || part.id);
                }

                const dims = part.dimensions; 
                const orig = part.origin; 
                const geometry = new THREE.BoxGeometry(dims.width, dims.height, dims.depth); 
                const mesh = new THREE.Mesh(geometry, intactPartMaterial); // Start with default grey
                mesh.position.set( orig.x + dims.width / 2, orig.z + dims.height / 2, orig.y + dims.depth / 2 ); 
                mesh.userData.part = part; 
                partMeshesMap.set(part.id, mesh); 
                objectGroup.add(mesh); 
                bounds.expandByObject(mesh); 
                const edges = new THREE.EdgesGeometry(geometry); 
                const line = new THREE.LineSegments(edges, outlineMaterial); 
                line.position.copy(mesh.position); 
                objectGroup.add(line); 
            }); 
            
            resetAllMaterials(); // Apply correct colors based on status

            const center = new THREE.Vector3(); 
            bounds.getCenter(center); 
            controls.target.copy(center); 
            
            let miaMessage = `Assembly "${objectName}" loaded.`;
            if (missingPartNames.length > 0) {
                miaMessage += ` <span style="color: #ffcc00;">Note: ${missingPartNames.length} part(s) marked as missing: ${missingPartNames.join(', ')}.</span>`;
            }
            updateMIA(miaMessage);
        }
        
        function onObjectClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const sphereIntersects = raycaster.intersectObjects(damageSpheres);
            const partIntersects = raycaster.intersectObjects(Array.from(partMeshesMap.values()));
            
            resetAllMaterials(); // First, reset everything to its base status color
            
            if (sphereIntersects.length > 0) {
                const clickedSphere = sphereIntersects[0].object;
                const damageInfo = clickedSphere.userData.damage;
                clickedSphere.material = selectedDotMaterial; 
                infoBox.style.color = '#ff0000';
                infoBox.innerHTML = `<b>${damageInfo.type}:</b><br>${damageInfo.description}`;
                infoBox.style.display = 'block';
                const associatedPart = partMeshesMap.get(damageInfo.part_id);
                if (associatedPart) { 
                    // Use selection material for temporary highlight
                    associatedPart.material = selectionPartMaterial; 
                }

            } else if (partIntersects.length > 0) {
                const clickedPart = partIntersects[0].object;
                const partData = clickedPart.userData.part;
                clickedPart.material = selectionPartMaterial; // Blue for selected part
                if (partData) {
                    const d = partData.dimensions;
                    infoBox.style.color = '#0000ff';
                    infoBox.innerHTML = `<b>Part:</b> ${partData.id.replace(/_/g, ' ')} (${partData.status})<br><b>Size:</b> ${(d.width*100).toFixed(1)}√ó${(d.height*100).toFixed(1)}√ó${(d.depth*100).toFixed(1)} cm`;
                    infoBox.style.display = 'block';
                }
            } else {
                infoBox.style.display = 'none';
            }
        }
        
        function viewGraph() {
            if (!currentModelJson || !currentModelJson.parts) return;

            let dotString = 'graph G {\n  graph [rankdir="LR" splines=true ranksep=2.5 nodesep=0.5];\n  node [shape=box, style="filled", fontname="Helvetica"];\n  edge [arrowhead=none];\n\n';
            const addedEdges = new Set();
            
            currentModelJson.parts.forEach(part => {
                let fillColor = '#f0f0f0'; // intact (grey)
                if (part.status === 'defective') fillColor = '#ffc0c0'; // defective (red-ish)
                if (part.status === 'missing') fillColor = '#ffee9c'; // missing (yellow-ish)
                
                dotString += `  "${part.id}" [label="${part.name}\\n(${part.status})", fillcolor="${fillColor}"];\n`;

                if (part.status !== 'missing' && part.connections && Array.isArray(part.connections)) {
                    part.connections.forEach(connectedId => {
                        const connectedPart = currentModelJson.parts.find(p => p.id === connectedId);
                        if (connectedPart && connectedPart.status !== 'missing') {
                             const edgeKey = [part.id, connectedId].sort().join('--');
                            if (!addedEdges.has(edgeKey)) {
                                dotString += `  "${part.id}" -- "${connectedId}";\n`;
                                addedEdges.add(edgeKey);
                            }
                        }
                    });
                }
            });

            dotString += '}';
            d3.select("#graph-container").graphviz({ useWorker: false }).engine('dot').renderDot(dotString);
            document.getElementById('graph-modal-overlay').style.display = 'flex';
        }

        function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (fileType === 'model') {
                        createModel(jsonData);
                        createDamageDots([]); 
                    } else if (fileType === 'damages') {
                        if (!currentModelJson) {
                            updateMIA("Please load an assembly geometry file first.");
                            return;
                        }
                        createDamageDots(jsonData);
                        resetAllMaterials(); 
                    }
                } catch (error) {
                    updateMIA(`Error: Could not parse the selected ${fileType} JSON file.`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        modelUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'model'));
        damagesUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'damages'));
        let currentAction = '';
        document.getElementById('upload-json-btn').addEventListener('click', () => { currentAction = 'upload'; document.getElementById('data-choice-title').textContent = "What do you want to upload?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('copy-json-btn').addEventListener('click', () => { currentAction = 'copy'; document.getElementById('data-choice-title').textContent = "What do you want to view/copy?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('download-json-btn').addEventListener('click', () => { currentAction = 'download'; document.getElementById('data-choice-title').textContent = "What do you want to download?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('view-graph-btn').addEventListener('click', viewGraph);
        document.getElementById('choice-btn-model').addEventListener('click', () => { if (currentAction === 'upload') modelUploadInput.click(); else if (currentAction === 'copy') viewJson('model'); else if (currentAction === 'download') downloadJson('model'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
        document.getElementById('choice-btn-damages').addEventListener('click', () => { if (currentAction === 'upload') damagesUploadInput.click(); else if (currentAction === 'copy') viewJson('damages'); else if (currentAction === 'download') downloadJson('damages'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
        function downloadJson(fileType) { const data = fileType === 'model' ? currentModelJson : currentDamageJson; const objectName = (document.getElementById('object-name').value.trim() || 'object').replace(/\s+/g, '_'); const fileName = `${objectName}_${fileType}.json`; if (!data) { updateMIA(`No ${fileType} data to download.`); return; } const jsonString = JSON.stringify(data, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url); updateMIA(`${fileType} JSON download initiated.`); }
        function viewJson(fileType) { const data = fileType === 'model' ? currentModelJson : currentDamageJson; if (!data) { updateMIA(`No ${fileType} data to show.`); return; } document.getElementById('json-view-title').textContent = `Current ${fileType === 'model' ? 'Assembly' : 'Damage'} JSON`; document.getElementById('json-view-textarea').value = JSON.stringify(data, null, 2); document.getElementById('json-view-modal-overlay').style.display = 'flex'; }
        document.querySelectorAll('.close-modal-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.target.closest('.modal-overlay').style.display = 'none'; }); });
        document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('json-view-textarea').value).then(() => { updateMIA("JSON copied to clipboard."); document.getElementById('json-view-modal-overlay').style.display = 'none'; }, () => { updateMIA("Failed to copy JSON."); }); });
        document.getElementById('add-files-btn').addEventListener('click', () => addFilesInput.click());
        addFilesInput.addEventListener('change', async (event) => { const files = event.target.files; if (!files.length) return; updateMIA(`Reading ${files.length} photo(s)...`); const filePromises = Array.from(files).map(file => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve({ mimeType: file.type, data: reader.result.split(',')[1] }); reader.onerror = reject; reader.readAsDataURL(file); }); }); try { uploadedFiles = await Promise.all(filePromises); updateMIA(`${uploadedFiles.length} photo(s) are ready. Click 'Catalog Damages' to analyze.`); } catch (error) { updateMIA("Error reading files. Please try again."); } addFilesInput.value = ''; });
        
        init();
    </script>
</body>
</html>