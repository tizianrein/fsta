<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Step 2: Catalog Damages</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background-color:#fff;color:#000;display:flex;justify-content:center;padding:20px 0}#app-wrapper{width:90%;max-width:420px;display:flex;flex-direction:column;gap:20px}.top-input-row{display:flex;align-items:stretch;gap:10px}#object-name{flex-grow:1;background-color:#f0f0f0;padding:12px;border:1px solid #000;border-radius:0;font-size:14px;box-sizing:border-box}#viewer-container{width:100%;height:40vh;position:relative;background-color:#fff; border: 1px solid #ccc;}#viewer-canvas{display:block;width:100%;height:100%}#bottom-ui-container{display:flex;flex-direction:column;gap:15px}.icon-controls{display:flex;justify-content:space-around;text-align:center;padding:10px 0}.icon-button{cursor:pointer;color:#000}.icon-button svg{width:18px;height:18px}.icon-button .label{font-size:12px;margin-top:5px}.action-buttons{display:flex;gap:10px}.btn{flex-grow:1;padding:12px;font-size:14px;font-weight:600;border:none;border-radius:0;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px;background-color:#000;color:#fff}.instructions-group{background-color:#fff;padding:15px;border:1px solid #000}.instructions-group label{display:block;font-size:12px;font-weight:600;margin-bottom:8px;color:#000}.instructions-group textarea{width:100%;height:60px;padding:10px;border:none;background-color:#fff;color:#000;border-radius:0;font-size:14px;box-sizing:border-box;resize:vertical}.hans-group{background-color:#000;color:#fff;padding:15px}#hans-output{font-family:"SF Mono",Consolas,Menlo,monospace;font-size:13px;line-height:1.5;min-height:20px}#hans-output-text{white-space:pre-wrap}.cursor{display:inline-block;background-color:#fff;width:8px;height:1em;animation:blink 1s step-end infinite}@keyframes blink{from,to{background-color:transparent}50%{background-color:#fff}}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center;padding:20px;box-sizing:border-box}.modal-content{background-color:#fff;padding:20px;border-radius:0;border:1px solid #000;width:100%;max-width:600px;display:flex;flex-direction:column}.modal-content h3{margin-top:0;color:#000}.modal-content textarea{width:100%;height:40vh;resize:none;font-family:monospace;font-size:12px;margin-bottom:10px;border-radius:0}.modal-actions{display:flex;justify-content:flex-end;gap:10px}.modal-btn{background-color:#000;color:#fff}.hidden-input{display:none} a{color:#000; text-decoration: none;}
    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <a href="startseite.html" style="text-align: center; margin-bottom: 10px;">&larr; Back to Workflow Overview</a>
        <div class="top-input-row">
            <input type="text" id="object-name" placeholder="Object name appears here..." readonly>
        </div>

        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
        </div>

        <div id="bottom-ui-container">
            <div class="icon-controls">
                <div id="upload-json-btn" class="icon-button" title="Upload a model or damage file"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload JSON</div></div>
                <div id="copy-json-btn" class="icon-button" title="View and copy model or damage JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy JSON</div></div>
                <div id="download-json-btn" class="icon-button" title="Download model or damage JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download JSON</div></div>
            </div>
            
            <div class="action-buttons">
                <button id="add-files-btn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/></svg>Add Damage Photos</button>
                <button id="catalog-damages-btn" class="btn">Catalog Damages</button>
            </div>

            <div class="instructions-group">
                <label for="additional-instructions">Describe Damages (optional, use with photos for better results)...</label>
                <textarea id="additional-instructions"></textarea>
            </div>

            <div class="hans-group">
                <div id="hans-output"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals and Hidden Inputs -->
    <div id="data-choice-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="data-choice-title">Select Data Type</h3><div class="action-buttons"><button id="choice-btn-model" class="btn modal-btn">Model Geometry</button><button id="choice-btn-damages" class="btn modal-btn">Damage Data</button></div><div class="modal-actions" style="margin-top: 20px;"><button class="btn modal-btn close-modal-btn">Cancel</button></div></div></div>
    <div id="json-view-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="json-view-title">Current JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <input type="file" id="model-upload-input" class="hidden-input" accept=".json, .txt"><input type="file" id="damages-upload-input" class="hidden-input" accept=".json, .txt"><input type="file" id="add-files-input" class="hidden-input" multiple accept="image/*">

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- (Code from previous step is identical up to this point) ---
        let scene, camera, renderer, controls;
        let currentModelJson = null;
        let currentDamageJson = null;
        let uploadedFiles = [];
        let typingInterval;
        let damageSpheres = [];
        const objectGroup = new THREE.Group();
        const HANS_PREFIX = `HANSðŸ§ : `;
        const viewerContainer = document.getElementById('viewer-container');
        const viewerCanvas = document.getElementById('viewer-canvas');
        const hansOutputEl = document.getElementById('hans-output');
        const modelUploadInput = document.getElementById('model-upload-input');
        const damagesUploadInput = document.getElementById('damages-upload-input');
        const addFilesInput = document.getElementById('add-files-input');
        function updateHANS(message) { if (typingInterval) clearInterval(typingInterval); hansOutputEl.innerHTML = `${HANS_PREFIX}<span id="hans-output-text"></span><span class="cursor"></span>`; const textEl = document.getElementById('hans-output-text'); const cursorEl = hansOutputEl.querySelector('.cursor'); let i = 0; typingInterval = setInterval(() => { if (i < message.length) { textEl.textContent += message.charAt(i); i++; } else { clearInterval(typingInterval); if (cursorEl) cursorEl.style.display = 'none'; } }, 30); }
        function init() { scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff); scene.add(objectGroup); camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000); camera.position.set(-1.1, 0.7, -1.1); renderer = new THREE.WebGLRenderer({ canvas: viewerCanvas, antialias: true, alpha: true }); renderer.setPixelRatio(window.devicePixelRatio); renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight); controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.target.set(0, 0.4, 0); const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7); directionalLight.position.set(2, 5, 3); scene.add(directionalLight); window.addEventListener('resize', onWindowResize); animate(); updateHANS("Welcome to Damage Cataloging. Please upload a model JSON to begin."); }
        function onWindowResize() { camera.aspect = viewerContainer.clientWidth / viewerContainer.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight); }
        function animate() { requestAnimationFrame(animate); controls.update(); const time = Date.now() * 0.008; const scale = 1 + Math.sin(time) * 0.5; damageSpheres.forEach(sphere => { if (sphere.visible) sphere.scale.set(scale, scale, scale); }); renderer.render(scene, camera); }
        function clearModel() { while(objectGroup.children.length > 0){ objectGroup.remove(objectGroup.children[0]); } }
        function clearDamages() { damageSpheres.forEach(sphere => scene.remove(sphere)); damageSpheres = []; currentDamageJson = null; }
        function createModel(jsonData) { clearModel(); let objectNameKey = Object.keys(jsonData).find(k => k.toLowerCase().includes('name')); let objectName = jsonData[objectNameKey] || 'Untitled'; if (!jsonData || !jsonData.parts || !Array.isArray(jsonData.parts)) { updateHANS("Error: Could not parse model file. Is it a valid JSON?"); return; } currentModelJson = jsonData; document.getElementById('object-name').value = objectName; const material = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.5 }); const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8 }); const bounds = new THREE.Box3().set(new THREE.Vector3(), new THREE.Vector3()); jsonData.parts.forEach(part => { const dims = part.dimensions; const orig = part.origin; const geometry = new THREE.BoxGeometry(dims.width, dims.height, dims.depth); const mesh = new THREE.Mesh(geometry, material); mesh.position.set( orig.x + dims.width / 2, orig.z + dims.height / 2, orig.y + dims.depth / 2 ); objectGroup.add(mesh); bounds.expandByObject(mesh); const edges = new THREE.EdgesGeometry(geometry); const line = new THREE.LineSegments(edges, outlineMaterial); line.position.copy(mesh.position); objectGroup.add(line); }); const center = new THREE.Vector3(); bounds.getCenter(center); controls.target.copy(center); updateHANS(`Model "${objectName}" loaded. You can now add photos to catalog damages.`); }
        function createDamageDots(damageData) { if (!Array.isArray(damageData)) { updateHANS("Error: Damage data is not a valid array."); return; } clearDamages(); currentDamageJson = damageData; const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16); const dotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 }); damageData.forEach(damage => { if (!damage.damagePosition || damage.damagePosition.length !== 3) return; const sphere = new THREE.Mesh(dotGeometry, dotMaterial); sphere.position.set(damage.damagePosition[0], damage.damagePosition[2], damage.damagePosition[1]); sphere.userData.info = damage.text; damageSpheres.push(sphere); scene.add(sphere); }); updateHANS(`Processed and visualized ${damageData.length} damages.`); }
        function handleFileUpload(event, fileType) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const jsonData = JSON.parse(e.target.result); if (fileType === 'model') { createModel(jsonData); } else if (fileType === 'damages') { if (!currentModelJson) { updateHANS("Please load a model geometry file first before loading damages."); return; } createDamageDots(jsonData); } } catch (error) { updateHANS(`Error: Could not parse the selected ${fileType} JSON file.`); } }; reader.readAsText(file); event.target.value = ''; }
        modelUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'model'));
        damagesUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'damages'));
        let currentAction = '';
        document.getElementById('upload-json-btn').addEventListener('click', () => { currentAction = 'upload'; document.getElementById('data-choice-title').textContent = "What do you want to upload?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('copy-json-btn').addEventListener('click', () => { currentAction = 'copy'; document.getElementById('data-choice-title').textContent = "What do you want to view/copy?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('download-json-btn').addEventListener('click', () => { currentAction = 'download'; document.getElementById('data-choice-title').textContent = "What do you want to download?"; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; });
        document.getElementById('choice-btn-model').addEventListener('click', () => { if (currentAction === 'upload') modelUploadInput.click(); else if (currentAction === 'copy') viewJson('model'); else if (currentAction === 'download') downloadJson('model'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
        document.getElementById('choice-btn-damages').addEventListener('click', () => { if (currentAction === 'upload') damagesUploadInput.click(); else if (currentAction === 'copy') viewJson('damages'); else if (currentAction === 'download') downloadJson('damages'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
        function downloadJson(fileType) { const data = fileType === 'model' ? currentModelJson : currentDamageJson; const objectName = (document.getElementById('object-name').value.trim() || 'object').replace(/\s+/g, '_'); const fileName = `${objectName}_${fileType}.json`; if (!data) { updateHANS(`No ${fileType} data to download.`); return; } const jsonString = JSON.stringify(data, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url); updateHANS(`${fileType} JSON download initiated.`); }
        function viewJson(fileType) { const data = fileType === 'model' ? currentModelJson : currentDamageJson; if (!data) { updateHANS(`No ${fileType} data to show.`); return; } document.getElementById('json-view-title').textContent = `Current ${fileType} JSON`; document.getElementById('json-view-textarea').value = JSON.stringify(data, null, 2); document.getElementById('json-view-modal-overlay').style.display = 'flex'; }
        document.querySelectorAll('.close-modal-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.target.closest('.modal-overlay').style.display = 'none'; }); });
        document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('json-view-textarea').value).then(() => { updateHANS("JSON copied to clipboard."); document.getElementById('json-view-modal-overlay').style.display = 'none'; }, () => { updateHANS("Failed to copy JSON."); }); });
        document.getElementById('add-files-btn').addEventListener('click', () => addFilesInput.click());
        addFilesInput.addEventListener('change', async (event) => { const files = event.target.files; if (!files.length) return; updateHANS(`Reading ${files.length} photo(s)...`); const filePromises = Array.from(files).map(file => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve({ mimeType: file.type, data: reader.result.split(',')[1] }); reader.onerror = reject; reader.readAsDataURL(file); }); }); try { uploadedFiles = await Promise.all(filePromises); updateHANS(`${uploadedFiles.length} photo(s) are ready. Click 'Catalog Damages' to analyze.`); } catch (error) { updateHANS("Error reading files. Please try again."); } addFilesInput.value = ''; });
        
        // --- <<< START OF UPDATED SECTION >>> ---
        document.getElementById('catalog-damages-btn').addEventListener('click', async () => {
            if (!currentModelJson) {
                updateHANS("Please upload a model geometry JSON before cataloging damages.");
                return;
            }
            if (uploadedFiles.length === 0 && !document.getElementById('additional-instructions').value.trim()) {
                updateHANS("Please add damage photos or describe the damages in text.");
                return;
            }
            updateHANS("Analyzing for damages... this may take a moment.");
            try {
                const payload = {
                    prompt: document.getElementById('additional-instructions').value,
                    modelJson: currentModelJson,
                    files: uploadedFiles
                };
                
                const response = await fetch('/api/catalog-damages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                // ROBUST ERROR HANDLING:
                if (!response.ok) {
                    let errorMsg;
                    try {
                        // Try to parse the error response as JSON, which is the expected format
                        const errorResult = await response.json();
                        errorMsg = errorResult.message || JSON.stringify(errorResult);
                    } catch (e) {
                        // If parsing fails, it's not JSON. Use the raw text response.
                        errorMsg = await response.text();
                    }
                    // Throw an error with the detailed message from the server
                    throw new Error(errorMsg);
                }

                // If the response was OK, proceed with parsing the successful result
                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                     throw new Error("Invalid response structure from the API. The model might have returned an empty response.");
                }

                const geminiResponseText = result.candidates[0].content.parts[0].text;
                const cleanedJsonString = geminiResponseText.replace(/```json\n|```/g, '').trim();
                const newDamageJson = JSON.parse(cleanedJsonString);
                
                createDamageDots(newDamageJson);
                uploadedFiles = [];
                document.getElementById('additional-instructions').value = '';

            } catch (error) {
                console.error("Damage Cataloging Error:", error);
                // The error message displayed is now much more informative
                updateHANS(`Sorry, an error occurred: ${error.message}`);
            }
        });
        // --- <<< END OF UPDATED SECTION >>> ---
        
        init();
    </script>
</body>
</html>