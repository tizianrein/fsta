<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Step 4: Execute Plan</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #fff; color: #000; display: flex; justify-content: center; padding: 20px 0; }

        #app-wrapper { width: 90%; max-width: 420px; display: flex; flex-direction: column; gap: 20px; }
        #top-header { display: flex; flex-direction: column; gap: 20px; }
        .top-input-row { display: flex; align-items: stretch; gap: 10px; }
        #object-name { flex-grow: 1; background-color: #f0f0f0; padding: 12px; border: 1px solid #000; border-radius: 0; font-size: 14px; box-sizing: border-box; }

        #viewer-container { width: 100%; height: 40vh; position: relative; background-color: #fff; }
        #viewer-canvas { display: block; width: 100%; height: 100%; }
        #info-box { position: absolute; top: 10px; left: 0px; padding: 0px; background-color: transparent; border: none; font-family: monospace; font-size: 12px; line-height: 1.4; z-index: 101; display: none; pointer-events: none; max-width: 250px; }

        #step-display-container { display: none; position: absolute; top: 10px; right: 0px; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; }
        #step-counter { font-family: monospace; font-size: 12px; color: #d00; margin-bottom: 5px; }
        .step-nav-arrow { cursor: pointer; display: block; width: 30px; height: 30px; border: 1px solid #d00; color: #d00; background-color: #fff; text-align: center; line-height: 28px; font-size: 20px; margin-top: 5px; user-select: none; }
        .step-nav-arrow.disabled { cursor: not-allowed; color: #ccc; border-color: #ccc; }
        #step-info-panel { display: none; position: absolute; bottom: 10px; left: 0px; right: 0px; background-color: rgba(221, 51, 51, 0.85); color: #fff; padding: 15px; border: 1px solid #d00; cursor: pointer; z-index: 100; }
        #step-info-panel h4 { margin: 0 0 5px 0; font-size: 16px; font-weight: bold; text-align: center;  }
        #step-info-panel p { margin: 0; font-size: 12px; }
        #step-info-panel .click-prompt { font-size: 8px; text-transform: uppercase; margin-top: 8px; opacity: 0.8; text-align: center; }

        #step-info-panel.completed {
            background-color: rgba(25, 135, 84, 0.85);
            border-color: #198754;
        }

        #bottom-ui-container { display: flex; flex-direction: column; gap: 15px; }
        .icon-controls { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; }
        .icon-button { cursor: pointer; color: #000; }
        .icon-button svg { width: 18px; height: 18px; }
        .icon-button .label { font-size: 12px; margin-top: 5px; }

        .action-buttons { display: flex; gap: 10px; }
        .btn { flex-grow: 1; padding: 12px; font-size: 14px; font-weight: 600; border: none; border-radius: 0; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn svg { width: 16px; height: 16px; fill: currentColor; }
        .btn-primary { background-color: #0d6efd; color: #fff; }
        .btn-success { background-color: #198754; color: #fff; }
        .btn-dark { background-color: #000; color: #fff; }
        .btn.disabled { background-color: #ccc; cursor: not-allowed; border: 1px solid #bbb; }
        
        .instructions-group { background-color: #fff; padding: 15px; border: 1px solid #000; }
        .instructions-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #000; }
        .instructions-group textarea { width: 100%; height: 60px; padding: 10px; border: none; background-color: #fff; color: #000; border-radius: 0; font-size: 14px; box-sizing: border-box; resize: vertical; }

        .helga-group { background-color: #000; color: #fff; padding: 15px; }
        #helga-output { font-family: "SF Mono", Consolas, Menlo, monospace; font-size: 13px; line-height: 1.5; min-height: 20px; white-space: pre-wrap; }
        #helga-output .cursor { display: inline-block; background-color: #fff; width: 8px; height: 1em; animation: blink 1s step-end infinite; }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #fff; }
        }

        .modal-overlay, .modal-content, .modal-actions { box-sizing: border-box; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #fff; padding: 20px; border: 1px solid #000; width: 100%; max-width: 400px; display: flex; flex-direction: column; max-height: 80vh; }
        .modal-content h3 { margin-top: 0; color: #000; text-align: center; }
        .modal-body { overflow-y: auto; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn { background-color: #000; color: #fff; }
        .hidden-input { display: none; }
        #json-view-modal-overlay .modal-content textarea { width: 100%; height: 40vh; resize: none; font-family: monospace; font-size: 12px; margin-bottom: 10px; border-radius: 0; }
        #graph-modal-overlay .modal-content { max-width: 90vw; height: 80vh; }
        #graph-container { width: 100%; height: calc(100% - 40px); }
        #graph-container svg { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="top-header">
            <div class="top-input-row">
                <input type="text" id="object-name" placeholder="Enter object name..." readonly>
            </div>
        </div>

        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
            <div id="info-box"></div>
            
            <div id="step-display-container">
                <div id="step-counter"></div>
                <div id="step-nav-next" class="step-nav-arrow">‚Üí</div>
                <div id="step-nav-prev" class="step-nav-arrow">‚Üê</div>
            </div>
            <div id="step-info-panel">
                <h4 id="step-info-title"></h4>
                <div class="click-prompt">(Click for more information)</div>
            </div>
        </div>
        
        <div id="bottom-ui-container">
             <div class="icon-controls">
                <div id="upload-json-btn" class="icon-button" title="Upload JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload JSON</div></div>
                <div id="copy-json-btn" class="icon-button" title="Read & Copy JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy JSON</div></div>
                <div id="view-plan-graph-btn" class="icon-button" title="View plan graph"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><div class="label">View Graph</div></div>
                <div id="download-json-btn" class="icon-button" title="Download JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download JSON</div></div>
            </div>
            
            <div class="action-buttons">
                <button id="start-btn" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>Start</button>
                <button id="done-btn" class="btn btn-success"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>Done!</button>
                <button id="ask-question-btn" class="btn btn-dark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>Ask</button>
                <button id="comment-btn" class="btn btn-dark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/></svg>Comment</button>
            </div>

            <div class="instructions-group">
                <label for="user-prompt">Ask a question or add a comment about the current step...</label>
                <textarea id="user-prompt" placeholder="e.g., 'What is the best type of glue for this?' or 'Completed, but the fit is tight.'"></textarea>
            </div>

            <div class="helga-group">
                <div id="helga-output"></div>
            </div>
        </div>
    </div>
    
    <div id="data-choice-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="data-choice-title">Select Data</h3><div class="action-buttons" style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="choice-btn-assembly" class="btn modal-btn">üì¶ Assembly</button><button id="choice-btn-damages" class="btn modal-btn">üìç Damages</button><button id="choice-btn-plan" class="btn modal-btn">üìã Plan</button><button id="choice-btn-history" class="btn modal-btn">üìñ History</button></div><div class="modal-actions" style="margin-top:20px"><button class="btn modal-btn close-modal-btn">Cancel</button></div></div></div>
    <div id="json-view-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="json-view-title">Current JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="graph-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="graph-title">Graph</h3><div id="graph-container"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="step-detail-modal-overlay" class="modal-overlay"><div class="modal-content"><h3>Step Details</h3><div id="step-detail-modal-body" class="modal-body"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>

    <input type="file" id="assembly-upload-input" class="hidden-input" accept=".json">
    <input type="file" id="damages-upload-input" class="hidden-input" accept=".json">
    <input type="file" id="plan-upload-input" class="hidden-input" accept=".json">

    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@2.12.2/dist/graphviz.umd.js"></script>
    <script src="https://unpkg.com/d3-graphviz@5.1.0/build/d3-graphviz.js"></script>
    <script type="importmap">{"imports": {"three": "https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const HELGA_PREFIX = "H.E.L.G.A.ü§ñ: ";
        let scene, camera, renderer, controls, axesScene, axesCamera, infoBox, raycaster, mouse;
        let typingInterval;
        let currentModelJson, currentDamageJson, currentHistoryJson;
        let currentStepIndex = 0;
        let stepStartTime = null;

        const objectGroup = new THREE.Group();
        const damageSpheres = [];
        const partMeshesMap = new Map();
        
        const viewerContainer = document.getElementById('viewer-container');
        const viewerCanvas = document.getElementById('viewer-canvas');
        const helgaOutputEl = document.getElementById('helga-output');
        const userPromptInput = document.getElementById('user-prompt');
        const stepDisplayContainer = document.getElementById('step-display-container');
        const stepInfoPanel = document.getElementById('step-info-panel');
        const stepCounterEl = document.getElementById('step-counter');
        const stepNavNextBtn = document.getElementById('step-nav-next');
        const stepNavPrevBtn = document.getElementById('step-nav-prev');
        const startBtn = document.getElementById('start-btn');
        const doneBtn = document.getElementById('done-btn');

        const defaultPartMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const stepHighlightMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const selectionPartMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff, transparent: true, opacity: 0.8, side: THREE.DoubleSide });
        const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8});
        const defaultDotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const selectedDotMaterial = new THREE.MeshBasicMaterial({ color: 0x6f0000 });
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.add(objectGroup);
            camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000);
            camera.position.set(-1.0, 0.9, -1.2);
            renderer = new THREE.WebGLRenderer({ canvas: viewerCanvas, antialias: true, alpha: true });
            renderer.autoClear = false;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.4, 0);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8), new THREE.DirectionalLight(0xffffff, 0.7, 3));
            axesScene = new THREE.Scene();
            const gizmoSize = 2.5;
            axesCamera = new THREE.OrthographicCamera(-gizmoSize, gizmoSize, gizmoSize, -gizmoSize, -10, 10);
            const axes = new THREE.AxesHelper(1.5);
            axes.rotation.x = -Math.PI / 2;
            axesScene.add(axes);
            infoBox = document.getElementById('info-box');
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            setupEventListeners();
            loadDefaults();
            animate();
        }

        function loadDefaults() {
            const defaultModel = { "objectName": "Default Cube", "parts": [{ "id": "cube", "origin": {"x": -0.25, "y": -0.25, "z": 0.0}, "dimensions": {"width": 0.5, "depth": 0.5, "height": 0.5}, "connections": [] }] };
            const defaultDamage = [{ "id": "damage_01", "type": "Scratch", "description": "A default scratch on the top surface.", "part_id": "cube", "coordinates": { "x": 0.0, "y": 0.0, "z": 0.5 } }];
            const defaultPlan = { "steps": [{ "step_number": 1, "title": "Fill Scratch", "description": "Apply wood filler to the scratch.", "tools_required": ["Wood filler"], "affected_parts": ["cube"], "affected_damages": ["damage_01"] }] };
            createModel(defaultModel);
            document.getElementById('object-name').value = "";
            createDamages(defaultDamage);
            initializeHistory(defaultPlan);
            updateHELGA("Hello! I am H.E.L.G.A. - the Helpful Electronic & Logistical Guidance Agent. Load a plan to begin the repair process.");
            displayCurrentStep();
        }
        
        function initializeHistory(planJson) {
            currentHistoryJson = JSON.parse(JSON.stringify(planJson)); 
            currentHistoryJson.steps.forEach(step => {
                step.completed = false;
                step.time_minutes = 0;
                step.comments = step.comments || "";
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.clear();
            renderer.render(scene, camera);
            renderer.clearDepth();
            const gizmoSize = 80;
            renderer.setViewport(10, 10, gizmoSize, gizmoSize);
            axesCamera.quaternion.copy(camera.quaternion);
            renderer.render(axesScene, axesCamera);
            renderer.setViewport(0, 0, renderer.domElement.clientWidth, renderer.domElement.clientHeight);
        }

        function onWindowResize() {
            const w = viewerContainer.clientWidth, h = viewerContainer.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }

        function saveCurrentComment() {
            if (!currentHistoryJson || !currentHistoryJson.steps[currentStepIndex]) return;
            const step = currentHistoryJson.steps[currentStepIndex];
            step.comments = userPromptInput.value.trim();
        }

        function displayCurrentStep() {
            if (!currentHistoryJson || !currentHistoryJson.steps || currentHistoryJson.steps.length === 0) {
                stepDisplayContainer.style.display = 'none';
                stepInfoPanel.style.display = 'none';
                return;
            }

            stepDisplayContainer.style.display = 'flex';
            stepInfoPanel.style.display = 'block';
            const step = currentHistoryJson.steps[currentStepIndex];
            if (!step) return;

            stepInfoPanel.classList.toggle('completed', step.completed);
            stepCounterEl.textContent = `Current Step: Nr. ${step.step_number}`;
            document.getElementById('step-info-title').textContent = step.title + (step.completed ? ' (Done)' : '');
            userPromptInput.value = step.comments || '';
            stepNavPrevBtn.classList.toggle('disabled', currentStepIndex === 0);
            stepNavNextBtn.classList.toggle('disabled', currentStepIndex === currentHistoryJson.steps.length - 1);
            highlightElements(step.affected_parts || [], step.affected_damages || [], stepHighlightMaterial);
            updateButtonStates();
        }

        function updateButtonStates() {
            if (!currentHistoryJson) return;
            const step = currentHistoryJson.steps[currentStepIndex];
            startBtn.classList.toggle('disabled', step.completed || !!stepStartTime);
            doneBtn.classList.toggle('disabled', step.completed || !stepStartTime);
        }

        function createModel(jsonData) {
            while (objectGroup.children.length > 0) objectGroup.remove(objectGroup.children[0]);
            partMeshesMap.clear();
            currentModelJson = jsonData;
            document.getElementById('object-name').value = jsonData.objectName || "Untitled";
            const bounds = new THREE.Box3();
            jsonData.parts.forEach(part => {
                const geo = new THREE.BoxGeometry(part.dimensions.width, part.dimensions.height, part.dimensions.depth);
                const pos = new THREE.Vector3(part.origin.x + part.dimensions.width/2, part.origin.z + part.dimensions.height/2, part.origin.y + part.dimensions.depth/2);
                const mesh = new THREE.Mesh(geo, defaultPartMaterial);
                mesh.position.copy(pos);
                mesh.userData.part = part;
                objectGroup.add(mesh);
                const line = new THREE.LineSegments(new THREE.EdgesGeometry(geo), outlineMaterial);
                line.position.copy(pos);
                objectGroup.add(line);
                partMeshesMap.set(part.id, mesh);
            });
            bounds.setFromObject(objectGroup);
            const center = new THREE.Vector3();
            bounds.getCenter(center);
            controls.target.copy(center);
        }

        function createDamages(jsonData) {
            damageSpheres.forEach(s => scene.remove(s));
            damageSpheres.length = 0;
            if(!currentModelJson) { updateHELGA("Error: Please load an assembly file first."); return; }
            currentDamageJson = jsonData;
            const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16);
            jsonData.forEach(damage => {
                const sphere = new THREE.Mesh(dotGeometry, defaultDotMaterial.clone());
                sphere.position.set(damage.coordinates.x, damage.coordinates.z, damage.coordinates.y);
                sphere.userData.damage = damage;
                damageSpheres.push(sphere);
                scene.add(sphere);
            });
        }
        
        function updateHELGA(message, isTyping = false, duration = 0) {
            if (typingInterval) clearInterval(typingInterval);
            if (isTyping) {
                 helgaOutputEl.innerHTML = `${HELGA_PREFIX}${message}`;
            } else if (duration > 0) {
                helgaOutputEl.innerHTML = `${HELGA_PREFIX}${message} (${duration.toFixed(2)} mins)`;
            } else {
                helgaOutputEl.innerHTML = `${HELGA_PREFIX}<span id="helga-text"></span><span class="cursor"></span>`;
                const textEl = document.getElementById('helga-text');
                const cursorEl = helgaOutputEl.querySelector('.cursor');
                if (!textEl || !cursorEl) return;
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < message.length) {
                        textEl.textContent += message.charAt(i++);
                    } else {
                        clearInterval(typingInterval);
                        if (cursorEl) cursorEl.style.display = 'none';
                    }
                }, 20);
            }
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (type === 'assembly') {
                        createModel(data);
                        updateHELGA("Assembly loaded. Please upload damages and a plan.");
                    } else if (type === 'damages') {
                        createDamages(data);
                        updateHELGA("Damages loaded. Please upload a plan.");
                    } else if (type === 'plan') {
                        initializeHistory(data);
                        currentStepIndex = 0;
                        displayCurrentStep();
                        updateHELGA(`Plan loaded with ${data.steps.length} steps. You can now start the repair.`);
                    }
                } catch (err) {
                    updateHELGA(`Error parsing ${type} file: ${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function viewJson(type) {
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentHistoryJson, history: currentHistoryJson };
            if (!dataMap[type]) { updateHELGA(`No ${type} data loaded.`); return; }
            document.getElementById('json-view-title').textContent = `Current ${type} JSON`;
            document.getElementById('json-view-textarea').value = JSON.stringify(dataMap[type], null, 2);
            document.getElementById('json-view-modal-overlay').style.display = 'flex';
        }

        function downloadJson(type) {
            saveCurrentComment();
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentHistoryJson, history: currentHistoryJson };
            if (!dataMap[type]) { updateHELGA(`No ${type} data loaded.`); return; }
            const name = (document.getElementById('object-name').value || 'object').replace(/\s+/g, '_');
            const blob = new Blob([JSON.stringify(dataMap[type], null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${name}_${type}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function highlightElements(partsToHighlight = [], damagesToHighlight = [], material) {
            partMeshesMap.forEach(mesh => { mesh.material = defaultPartMaterial; });
            damagesToHighlight.forEach(damageId => {
                const sphere = damageSpheres.find(s => s.userData.damage.id === damageId);
                if (sphere) sphere.material = selectedDotMaterial;
            });
            partsToHighlight.forEach(partId => {
                const mesh = partMeshesMap.get(partId);
                if (mesh) mesh.material = material;
            });
        }

        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            viewerCanvas.addEventListener('click', (event) => { /* Click logic here */ });

            startBtn.addEventListener('click', () => {
                if (startBtn.classList.contains('disabled')) return;
                stepStartTime = new Date();
                updateButtonStates();
                updateHELGA("Timer started for the current step.");
            });

            doneBtn.addEventListener('click', () => {
                if (doneBtn.classList.contains('disabled') || !stepStartTime) return;
                const durationMinutes = (new Date() - stepStartTime) / 60000;
                const step = currentHistoryJson.steps[currentStepIndex];
                step.completed = true;
                step.time_minutes = parseFloat(durationMinutes.toFixed(2));
                saveCurrentComment();
                stepStartTime = null;
                displayCurrentStep();
                updateHELGA(`Step ${step.step_number} completed! Time taken:`, false, durationMinutes);
            });

            document.getElementById('ask-question-btn').addEventListener('click', async () => {
                const question = userPromptInput.value.trim();
                if (!question) { updateHELGA("Please type a question in the text area first."); return; }
                if (!currentHistoryJson) { updateHELGA("Please load a plan first."); return; }
                const currentStep = currentHistoryJson.steps[currentStepIndex];
                updateHELGA("Thinking...", true);
                try {
                    const response = await fetch('/api/guide-repair', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question, stepContext: currentStep })
                    });
                    if (!response.ok) {
                        let errorMsg = `Server error ${response.status}. Check API file name and location.`;
                        try { errorMsg = (await response.json()).message || errorMsg; } catch (e) {}
                        throw new Error(errorMsg);
                    }
                    const result = await response.json();
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        throw new Error(result.candidates?.[0]?.finishReason === "SAFETY" ? "Request blocked for safety reasons." : "Invalid API response.");
                    }
                    updateHELGA(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.error("Ask H.E.L.G.A. Error:", error);
                    updateHELGA(`Sorry, an error occurred: ${error.message}`);
                }
            });

            document.getElementById('comment-btn').addEventListener('click', () => {
                 if (!currentHistoryJson) { updateHELGA("Please load a plan first."); return; }
                 saveCurrentComment();
                 updateHELGA("Your comment has been saved to the history file for this step.");
            });
            
            let currentAction = '';
            document.querySelectorAll('[id$="-json-btn"]').forEach(btn => btn.addEventListener('click', () => {
                const action = btn.id.split('-')[0]; // upload, copy, download
                currentAction = action;
                document.getElementById('data-choice-title').textContent = `What to ${action}?`;
                document.getElementById('data-choice-modal-overlay').style.display = 'flex';
            }));
            
            document.getElementById('view-plan-graph-btn').addEventListener('click', () => { /* View Graph Logic */ });

            document.getElementById('choice-btn-assembly').addEventListener('click', () => handleChoice('assembly'));
            document.getElementById('choice-btn-damages').addEventListener('click', () => handleChoice('damages'));
            document.getElementById('choice-btn-plan').addEventListener('click', () => handleChoice('plan'));
            document.getElementById('choice-btn-history').addEventListener('click', () => handleChoice('history'));

            function handleChoice(type) {
                const actions = {
                    upload: () => document.getElementById(`${type}-upload-input`).click(),
                    copy: () => viewJson(type),
                    download: () => downloadJson(type)
                };
                actions[currentAction]?.();
                document.getElementById('data-choice-modal-overlay').style.display = 'none';
            }

            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', e => e.target.closest('.modal-overlay').style.display = 'none'));
            document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('json-view-textarea').value);
                updateHELGA("JSON copied to clipboard.");
                document.getElementById('json-view-modal-overlay').style.display = 'none';
            });

            stepNavNextBtn.addEventListener('click', () => navigateSteps(1));
            stepNavPrevBtn.addEventListener('click', () => navigateSteps(-1));

            function navigateSteps(direction) {
                saveCurrentComment();
                const newIndex = currentStepIndex + direction;
                if (newIndex >= 0 && newIndex < currentHistoryJson.steps.length) {
                    currentStepIndex = newIndex;
                    displayCurrentStep();
                }
            }
            
            stepInfoPanel.addEventListener('click', () => {
                if (!currentHistoryJson || !currentHistoryJson.steps) return;
                const step = currentHistoryJson.steps[currentStepIndex];
                if (!step) return;
                const body = document.getElementById('step-detail-modal-body');
                body.innerHTML = `<p>${step.description}</p><b>Tools:</b><ul>${(step.tools_required||[]).map(t=>`<li>${t}</li>`).join('')}</ul>`;
                document.getElementById('step-detail-modal-overlay').style.display = 'flex';
            });

            document.getElementById('assembly-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'assembly'));
            document.getElementById('damages-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'damages'));
            document.getElementById('plan-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'plan'));
        }
        
        init();
    </script>
</body>
</html>