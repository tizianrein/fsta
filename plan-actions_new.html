<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Step 3: Plan Actions</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #fff; color: #000; display: flex; justify-content: center; padding: 20px 0; }
        #app-wrapper { width: 90%; max-width: 520px; display: flex; flex-direction: column; gap: 20px; }
        #top-header { display: flex; flex-direction: column; gap: 20px; }
        .top-input-row { display: flex; align-items: stretch; gap: 10px; }
        #object-name { flex-grow: 1; background-color: #f0f0f0; padding: 12px; border: 1px solid #000; border-radius: 0; font-size: 14px; box-sizing: border-box; }
        #viewer-container { width: 100%; height: 40vh; position: relative; background-color: #fff; }
        #viewer-canvas { display: block; width: 100%; height: 100%; }
        #info-box { position: absolute; top: 10px; left: 0px; padding: 0px; background-color: transparent; border: none; font-family: monospace; font-size: 12px; line-height: 1.4; z-index: 101; display: none; pointer-events: none; max-width: 250px; }
        #step-display-container { display: none; position: absolute; top: 10px; right: 0px; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; }
        .step-nav-arrow { cursor: pointer; display: block; width: 30px; height: 30px; border: 1px solid #d00; color: #d00; background-color: #fff; text-align: center; line-height: 28px; font-size: 20px; margin-top: 5px; user-select: none; }
        .step-nav-arrow.disabled { cursor: not-allowed; color: #ccc; border-color: #ccc; }
        #step-info-panel { display: none; position: absolute; bottom: 10px; left: 0px; right: 0px; background-color: rgba(221, 51, 51, 0.85); color: #fff; padding: 15px; border: 1px solid #d00; cursor: pointer; z-index: 100; }
        #step-info-panel h4 { margin: 0 0 5px 0; font-size: 16px; font-weight: bold; text-align: center;  }
        #step-info-panel .click-prompt { font-size: 8px; text-transform: uppercase; margin-top: 8px; opacity: 0.8; text-align: center; }
        #bottom-ui-container { display: flex; flex-direction: column; gap: 12px; }
        .icon-controls { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; }
        .icon-button { cursor: pointer; color: #000; }
        .icon-button svg { width: 18px; height: 18px; }
        .icon-button .label { font-size: 12px; margin-top: 5px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { flex-grow: 1; padding: 12px; font-size: 14px; font-weight: 600; border: none; border-radius: 0; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; background-color: #000; color: #fff; }
        .instructions-group { background-color: #fff; padding: 15px; border: 1px solid #000; }
        .instructions-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #000; }
        .instructions-group textarea { width: 100%; height: 60px; padding: 10px; border: none; background-color: #fff; color: #000; border-radius: 0; font-size: 14px; box-sizing: border-box; resize: vertical; }
        .rolf-group { background-color: #000; color: #fff; padding: 15px; }
        #rolf-output { font-family: "SF Mono", Consolas, Menlo, monospace; font-size: 13px; line-height: 1.5; min-height: 20px; white-space: pre-wrap; }
        #rolf-output .cursor { display: inline-block; background-color: #fff; width: 8px; height: 1em; animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: #fff; } }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fff; padding: 20px; border: 1px solid #000; width: 100%; max-width: 400px; display: flex; flex-direction: column; max-height: 80vh; position: relative; }
        .svg-save-btn { position: absolute; top: 20px; left: 20px; flex-grow: 0; z-index: 10; }
        .modal-content h3 { margin-top: 0; color: #000; text-align: center; }
        .modal-body { overflow-y: auto; }
        #step-detail-modal-body ul { padding-left: 20px; margin: 10px 0; }
        #step-detail-modal-body li { margin-bottom: 5px; }
        #step-detail-modal-body b { display: block; margin-top: 15px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn { background-color: #000; color: #fff; }
        .hidden-input { display: none; }
        #json-view-modal-overlay .modal-content textarea { width: 100%; height: 40vh; resize: none; font-family: monospace; font-size: 12px; margin-bottom: 10px; border-radius: 0; }
        #graph-modal-overlay .modal-content { max-width: 90vw; height: 80vh; }
        #graph-container { width: 100%; flex-grow: 1; min-height: 0; }
        #graph-container svg { width: 100%; height: 100%; }
        #graph-title { margin-top: 45px; }
        #settings-btn { flex-grow: 0; padding: 0 12px; }
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; font-size: 14px; margin-bottom: 8px; }
        .settings-input { width: 100%; padding: 10px; border: 1px solid #000; border-radius: 0; font-size: 14px; box-sizing: border-box; }
        #step-nav-choices { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; margin-bottom: 5px; }
        /* MODIFIED: Updated button styles for better size and appearance */
        .step-choice-btn {
            cursor: pointer;
            border: 1px solid #d00;
            color: #d00;
            background-color: #fff;
            padding: 0 10px; /* Adjusted padding */
            font-size: 14px;  /* Increased font size */
            user-select: none;
            text-align: right;
            min-width: 120px;
            height: 30px;     /* Set height to match back arrow */
            line-height: 28px; /* Vertically center text */
        }
        .step-choice-btn:hover { background-color: #d00; color: #fff; }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="top-header">
            <div class="top-input-row">
                <input type="text" id="object-name" placeholder="Enter object name... (optional)" readonly>
                <button id="settings-btn" class="btn icon-button" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
        <div id="viewer-container">
            <canvas id="viewer-canvas"></canvas>
            <div id="info-box"></div>
            <div id="step-display-container">
                <div id="step-nav-choices"></div>
                <div id="step-nav-prev" class="step-nav-arrow">‚Üê</div>
            </div>
            <div id="step-info-panel">
                <h4 id="step-info-title"></h4>
                <div class="click-prompt">(Click for more information)</div>
            </div>
        </div>
        <div id="bottom-ui-container">
             <div class="icon-controls">
                <div id="upload-json-btn" class="icon-button" title="Upload JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><div class="label">Upload</div></div>
                <div id="copy-json-btn" class="icon-button" title="Read & Copy JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/><path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/></svg><div class="label">Read & Copy</div></div>
                <div id="explode-view-btn" class="icon-button" title="Explode View"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"/></svg><div class="label">Explode</div></div>
                <div id="reset-view-btn" class="icon-button" title="Reset View" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M.172 15.828a.5.5 0 0 0 .707 0l4.096-4.096V14.5a.5.5 0 1 0 1 0v-3.975a.5.5 0 0 0-.5-.5H1.5a.5.5 0 0 0 0 1h2.768L.172 15.121a.5.5 0 0 0 0 .707zM15.828.172a.5.5 0 0 0-.707 0l-4.096 4.096V1.5a.5.5 0 1 0-1 0v3.975a.5.5 0 0 0 .5.5H14.5a.5.5 0 0 0 0-1h-2.768L15.828.879a.5.5 0 0 0 0-.707z"/></svg><div class="label">Restore</div></div>
                <div id="view-plan-graph-btn" class="icon-button" title="View repair-plan graph"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg><div class="label">Graph</div></div>
                <div id="download-drawings-btn" class="icon-button" title="Download Drawings"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="14" height="14" rx="2"></rect><line x1="9" y1="6" x2="9" y2="12"></line><line x1="6" y1="9" x2="12" y2="9"></line></svg><div class="label">Drawings</div></div>
                <div id="download-json-btn" class="icon-button" title="Download JSON"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg><div class="label">Download</div></div>
            </div>
            <div class="action-buttons">
                <button id="create-intervention-btn" class="btn">üèóÔ∏è Create Intervention</button>
                <button id="generate-plan-btn" class="btn">üìù Plan Actions</button>
            </div>
            <div class="instructions-group">
                <label for="user-prompt">Make changes or give specific instructions...</label>
                <textarea id="user-prompt" placeholder="e.g., 'Add a support under the seat' or 'Remove step 2.'"></textarea>
            </div>
            <div class="rolf-group">
                <div id="rolf-output"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="data-choice-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="data-choice-title">Select Data</h3><div class="action-buttons"><button id="choice-btn-assembly" class="btn modal-btn">üì¶ Assembly</button><button id="choice-btn-damages" class="btn modal-btn">üìç Damages</button><button id="choice-btn-plan" class="btn modal-btn">üìã Repair-Plan</button></div><div class="modal-actions" style="margin-top:20px"><button class="btn modal-btn close-modal-btn">Cancel</button></div></div></div>
    <div id="json-view-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="json-view-title">Current JSON</h3><textarea id="json-view-textarea" readonly></textarea><div class="modal-actions"><button id="copy-json-from-modal-btn" class="btn modal-btn">Copy</button><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="graph-modal-overlay" class="modal-overlay"><div class="modal-content"><button id="save-graph-svg-btn" class="btn modal-btn svg-save-btn">Save as SVG</button><h3 id="graph-title">Graph</h3><div id="graph-container"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="step-detail-modal-overlay" class="modal-overlay"><div class="modal-content"><h3>Step Details</h3><div class="modal-body" id="step-detail-modal-body"></div><div class="modal-actions"><button class="btn modal-btn close-modal-btn">Close</button></div></div></div>
    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3>Settings</h3>
            <div class="settings-group">
                <label for="brain-select">Select Repair Brain</label>
                <select id="brain-select" class="settings-input"></select>
            </div>
            <div class="settings-group">
                <label for="model-select">Select AI Model</label>
                <select id="model-select" class="settings-input">
                    <option value="gemini-2.5-flash-lite">Fast</option>
                    <option value="gemini-2.5-flash">Balanced</option>
                    <option value="gemini-2.5-pro" selected>Accurate</option>
                </select>
            </div>
            <div class="settings-group">
                <label for="temperature-slider">Creativity (Temperature): <span id="temperature-value">0.4</span></label>
                <input type="range" id="temperature-slider" class="settings-input" min="0" max="1" step="0.1" value="0.4">
            </div>
            <div class="settings-group">
                <label for="sphere-scale-slider">Damage Marker Scale: <span id="sphere-scale-value">1.00</span></label>
                <input type="range" id="sphere-scale-slider" class="settings-input" min="0.5" max="5" step="0.1" value="1.0">
            </div>
            <div class="modal-actions">
                <button id="save-settings-btn" class="btn modal-btn">Save</button>
                <button class="btn modal-btn close-modal-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="assembly-upload-input" class="hidden-input" accept=".json"><input type="file" id="damages-upload-input" class="hidden-input" accept=".json"><input type="file" id="plan-upload-input" class="hidden-input" accept=".json">

    <!-- Libraries -->
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script><script src="https://unpkg.com/@hpcc-js/wasm@2.12.2/dist/graphviz.umd.js"></script><script src="https://unpkg.com/d3-graphviz@5.1.0/build/d3-graphviz.js"></script>
    <script type="importmap">{"imports": {"three": "https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONSTANTS & GLOBALS ---
        const ROLF_PREFIX = "R.O.L.F.üî•: ";
        const ANIMATION_DURATION = 800;
        const brains = [
            { id: "janitors-cookbook", name: "The Janitor's Cookbook", emoji: "üßπ" },
            { id: "long-term-thinker", name: "The Long-Term Thinker", emoji: "‚è≥" },
            { id: "readymade-brain", name: "The Readymade Brain", emoji: "üö≤" },
            { id: "anarchitect", name: "The Anarchitect", emoji: "üî™" },
            { id: "purist", name: "The Purist", emoji: "üï∏Ô∏è" },
            { id: "gentle-craftsman", name: "The Gentle Craftsman", emoji: "üõ†Ô∏è" },
            { id: "jeweler-of-joints", name: "The Jeweler of Joints", emoji: "‚ú®" },
            { id: "urbanist", name: "The Urbanist", emoji: "üèôÔ∏è" },
            { id: "preservation-scientist", name: "The Preservation Scientist", emoji: "üî¨" },
            { id: "stylistic-idealist", name: "The Stylistic Idealist", emoji: "üè∞" }
        ];
        let scene, camera, renderer, controls, axesScene, axesCamera, infoBox, raycaster, mouse;
        let typingInterval, timerInterval;
        let currentModelJson, currentDamageJson, currentPlanJson, selectedBrainId;
        let currentStepId = null;
        let stepHistory = [];
        let planMap = new Map();
        let activeAnimations = [];
        let temperature = 0.4, geminiModel = 'gemini-2.5-pro', sphereScale = 1.0;
        const objectGroup = new THREE.Group();
        const damageSpheres = [];
        const partMeshesMap = new Map();
        
        // --- DOM ELEMENTS ---
        const viewerContainer = document.getElementById('viewer-container');
        const rolfOutputEl = document.getElementById('rolf-output');
        const userPromptInput = document.getElementById('user-prompt');
        const stepDisplayContainer = document.getElementById('step-display-container');
        const stepInfoPanel = document.getElementById('step-info-panel');
        const stepNavPrevBtn = document.getElementById('step-nav-prev');
        const explodeBtn = document.getElementById('explode-view-btn');
        const resetBtn = document.getElementById('reset-view-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal-overlay');
        const brainSelect = document.getElementById('brain-select');
        const modelSelect = document.getElementById('model-select');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValue = document.getElementById('temperature-value');
        const sphereScaleSlider = document.getElementById('sphere-scale-slider');
        const sphereScaleValue = document.getElementById('sphere-scale-value');
        const saveSettingsBtn = document.getElementById('save-settings-btn');

        // --- MATERIALS ---
        const intactPartMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const defectivePartMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const missingPartMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const selectionPartMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff, transparent: true, opacity: 0.7, side: THREE.DoubleSide });
        const newMaterial = new THREE.MeshStandardMaterial({ color: 0x00f6f6, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const discardedMaterial = new THREE.MeshStandardMaterial({ color: 0xff8000, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8});
        const defaultDotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const selectedDotMaterial = new THREE.MeshBasicMaterial({ color: 0x6f0000 });
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.add(objectGroup);
            camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.01, 1000);
            camera.position.set(-0.8, 1.0, -1.2);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('viewer-canvas'), antialias: true, alpha: true });
            renderer.autoClear = false;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0, 0);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8), new THREE.DirectionalLight(0xffffff, 0.7, 3));
            axesScene = new THREE.Scene();
            const gizmoSize = 2.5;
            axesCamera = new THREE.OrthographicCamera(-gizmoSize, gizmoSize, gizmoSize, -gizmoSize, -10, 10);
            axesScene.add(new THREE.AxesHelper(1.5));
            infoBox = document.getElementById('info-box');
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            setupEventListeners();
            populateBrainSelect();
            loadDefaults();
            animate();
        }

        function loadDefaults() {
            const defaultModel = { "objectName": "", "parts": [{ "id": "cube", "status": "defective", "origin": {"x": 0, "y": 0.25, "z": 0}, "dimensions": {"width": 0.5, "depth": 0.5, "height": 0.5}, "connections": [] }] };
            const defaultDamage = [{ "id": "damage_01", "type": "Scratch", "description": "A default scratch.", "part_id": "cube", "coordinates": { "x": 0.0, "y": 0.5, "z": 0.0 } }];
            const defaultPlan = { "steps": [{ "step_id": "fill_scratch", "title": "Fill Scratch", "description": "Apply wood filler to the scratch.", "tools_required": ["Wood filler"], "affected_parts": ["cube"], "affected_damages": ["damage_01"], "prerequisites": [] }] };
            createModel(defaultModel);
            document.getElementById('object-name').value = ""; 
            createDamages(defaultDamage);
            processNewPlan(defaultPlan);
            updateROLF("Hello! I am R.O.L.F. - the Repair Option Layout Finder. Load your data to begin.");
        }

        function animate() {
            requestAnimationFrame(animate);
            if (activeAnimations.length > 0) {
                const now = performance.now();
                activeAnimations.forEach(anim => {
                    const progress = Math.min((now - anim.startTime) / ANIMATION_DURATION, 1);
                    const easedProgress = 1 - Math.pow(1 - progress, 3);
                    anim.mesh.position.lerpVectors(anim.start, anim.end, easedProgress);
                });
                activeAnimations = activeAnimations.filter(anim => now - anim.startTime < ANIMATION_DURATION);
            }
            controls.update();
            const time = Date.now() * 0.008;
            const scale = sphereScale * (1 + Math.sin(time) * 0.1);
            damageSpheres.forEach(sphere => sphere.scale.set(scale, scale, scale));
            renderer.clear();
            renderer.render(scene, camera);
            renderer.clearDepth();
            renderer.setViewport(10, 10, 80, 80);
            axesCamera.quaternion.copy(camera.quaternion);
            renderer.render(axesScene, axesCamera);
            renderer.setViewport(0, 0, renderer.domElement.clientWidth, renderer.domElement.clientHeight);
        }

        function clearAll() {
            while (objectGroup.children.length > 0) objectGroup.remove(objectGroup.children[0]);
            partMeshesMap.clear();
            currentModelJson = null;
            document.getElementById('object-name').value = "";
            damageSpheres.forEach(s => scene.remove(s));
            damageSpheres.length = 0;
            currentDamageJson = null;
            currentPlanJson = null;
            currentStepId = null;
            stepHistory = [];
            planMap.clear();
            displayCurrentStep();
        }

        function createModel(jsonData) {
            while (objectGroup.children.length > 0) objectGroup.remove(objectGroup.children[0]);
            partMeshesMap.clear();
            currentModelJson = jsonData;
            document.getElementById('object-name').value = jsonData.objectName || "Untitled";

            jsonData.parts.forEach(part => {
                const geo = new THREE.BoxGeometry(part.dimensions.width, part.dimensions.height, part.dimensions.depth);
                const pos = new THREE.Vector3(part.origin.x, part.origin.y, part.origin.z);
                const partGroup = new THREE.Group();
                let material;
                switch (part.status) {
                    case 'new': material = newMaterial; break;
                    case 'discarded': material = discardedMaterial; break;
                    case 'missing': material = missingPartMaterial; break;
                    case 'defective': material = defectivePartMaterial; break;
                    default: material = intactPartMaterial; break;
                }
                const mesh = new THREE.Mesh(geo, material);
                const line = new THREE.LineSegments(new THREE.EdgesGeometry(geo), outlineMaterial);
                partGroup.add(mesh, line);
                partGroup.userData.originalPosition = pos.clone();
                partGroup.position.copy(pos);
                if (part.rotation) partGroup.rotation.set(part.rotation.x || 0, part.rotation.y || 0, part.rotation.z || 0, 'YXZ');
                partGroup.userData.part = part;
                objectGroup.add(partGroup);
                partMeshesMap.set(part.id, mesh);
            });
            const bounds = new THREE.Box3().setFromObject(objectGroup);
            controls.target.copy(bounds.getCenter(new THREE.Vector3()));
            resetBtn.style.display = 'none';
            explodeBtn.style.display = 'inline-block';
        }

        function createDamages(jsonData) {
            damageSpheres.forEach(s => scene.remove(s));
            damageSpheres.length = 0;
            if(!currentModelJson || !Array.isArray(jsonData)) return;
            currentDamageJson = jsonData;
            const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16);
            jsonData.forEach(damage => {
                if (!damage.coordinates || !damage.part_id) return;
                const partData = currentModelJson.parts.find(p => p.id === damage.part_id);
                if (!partData) return;
                const origin = new THREE.Vector3(partData.origin.x, partData.origin.y, partData.origin.z);
                const localOffset = new THREE.Vector3().subVectors(new THREE.Vector3(damage.coordinates.x, damage.coordinates.y, damage.coordinates.z), origin);
                const euler = new THREE.Euler(partData.rotation?.x || 0, partData.rotation?.y || 0, partData.rotation?.z || 0, 'YXZ');
                const finalPosition = localOffset.clone().applyMatrix4(new THREE.Matrix4().compose(origin, new THREE.Quaternion().setFromEuler(euler), new THREE.Vector3(1, 1, 1)));
                const sphere = new THREE.Mesh(dotGeometry, defaultDotMaterial.clone());
                sphere.position.copy(finalPosition);
                sphere.userData.damage = damage;
                damageSpheres.push(sphere);
                scene.add(sphere);
            });
        }
        
        function highlightElements(partsToHighlight, damagesToHighlight) {
            partMeshesMap.forEach((mesh) => {
                const part = mesh.parent.userData.part;
                if (!part) return;
                switch (part.status) {
                    case 'new': mesh.material = newMaterial; break;
                    case 'discarded': mesh.material = discardedMaterial; break;
                    case 'missing': mesh.material = missingPartMaterial; break;
                    case 'defective': mesh.material = (currentPlanJson && currentPlanJson.steps && currentPlanJson.steps.length > 0) ? intactPartMaterial : defectivePartMaterial; break;
                    default: mesh.material = intactPartMaterial; break;
                }
            });
            damageSpheres.forEach(sphere => { sphere.material = defaultDotMaterial; });
            damagesToHighlight.forEach(damageId => {
                const sphere = damageSpheres.find(s => s.userData.damage.id === damageId);
                if (sphere) sphere.material = selectedDotMaterial;
            });
            partsToHighlight.forEach(partId => {
                const mesh = partMeshesMap.get(partId);
                if (mesh) mesh.material = defectivePartMaterial; 
            });
        }
        
        function processNewPlan(newPlan) {
            currentPlanJson = newPlan;
            planMap.clear();
            stepHistory = [];
            if (currentPlanJson && currentPlanJson.steps) {
                currentPlanJson.steps.forEach(step => planMap.set(step.step_id, step));
                const startStep = currentPlanJson.steps.find(step => !step.prerequisites || step.prerequisites.length === 0);
                currentStepId = startStep ? startStep.step_id : null;
            } else {
                currentStepId = null;
            }
            displayCurrentStep();
        }

        function displayCurrentStep() {
            if (!currentPlanJson || !currentStepId || !planMap.has(currentStepId)) {
                stepDisplayContainer.style.display = 'none';
                stepInfoPanel.style.display = 'none';
                highlightElements([], []);
                return;
            }
            
            stepDisplayContainer.style.display = 'flex';
            stepInfoPanel.style.display = 'block';
            
            const step = planMap.get(currentStepId);
            document.getElementById('step-info-title').textContent = step.title;
            
            const choicesContainer = document.getElementById('step-nav-choices');
            choicesContainer.innerHTML = ''; // Clear previous buttons

            const currentlyCompletedAndHistory = new Set([...stepHistory, currentStepId]);

            // --- FIX 1: Find FORWARD steps using only direct dependency ---
            const availableChoices = currentPlanJson.steps.filter(s =>
                !currentlyCompletedAndHistory.has(s.step_id) && 
                s.prerequisites && s.prerequisites.includes(currentStepId)
            );

            // --- Find BACKWARD steps ---
            const prerequisites = step.prerequisites || [];

            // --- FIX 2: Render FORWARD CHOICES FIRST ---
            if (availableChoices.length > 0) {
                availableChoices.forEach(choice => {
                    const btn = document.createElement('div');
                    btn.textContent = `${choice.title} ‚Üí`;
                    btn.className = 'step-choice-btn'; // Use existing red-bordered style for forward actions
                    btn.onclick = () => {
                        stepHistory.push(currentStepId);
                        currentStepId = choice.step_id;
                        displayCurrentStep();
                    };
                    choicesContainer.appendChild(btn);
                });
            } else {
                // If there are no forward options, this is the end of a branch or the whole plan.
                const isTerminalNode = !currentPlanJson.steps.some(s => s.prerequisites && s.prerequisites.includes(currentStepId));
                if (isTerminalNode) {
                    const info = document.createElement('div');
                    // 1. Use innerHTML to add the checkmark emoji before the text
                    info.innerHTML = "‚úî No further Steps";
                    info.className = 'step-choice-btn';
                    info.style.cursor = 'default'; 
                    info.style.color = '#1a73e8';
                    info.style.borderColor = '#1a73e8';
                    info.style.backgroundColor = '#e8f0fe';
                    // 2. Center the text to fix the alignment gap
                    info.style.textAlign = 'center';
                    choicesContainer.appendChild(info);
                }
            }
            
            // --- FIX 2: Render BACKWARD CHOICES SECOND, ensuring they appear underneath ---
            prerequisites.forEach(prereqId => {
                const prereqStep = planMap.get(prereqId);
                if (prereqStep) {
                    const btn = document.createElement('div');
                    btn.textContent = `‚Üê ${prereqStep.title}`; 
                    btn.className = 'step-choice-btn';
                    // Style back buttons to be less prominent
                    btn.style.borderColor = '#ccc'; 
                    btn.style.color = '#333';
                    btn.style.backgroundColor = '#fff';

                    // Make hover state consistent but for grey
                    btn.onmouseover = () => { btn.style.backgroundColor = '#f0f0f0'; };
                    btn.onmouseout = () => { btn.style.backgroundColor = '#fff'; };

                    btn.onclick = () => {
                        // The prerequisite becomes the new current step.
                        const newCurrentStepId = prereqId;

                        // Find the last time this prerequisite was in our path.
                        const historyIndex = stepHistory.lastIndexOf(newCurrentStepId);

                        if (historyIndex > -1) {
                            // Rewind history to the point just before that prerequisite was completed.
                            stepHistory.length = historyIndex;
                        }
                        
                        currentStepId = newCurrentStepId;
                        displayCurrentStep();
                    };
                    choicesContainer.appendChild(btn);
                }
            });

            // We no longer need the original single back button.
            stepNavPrevBtn.style.display = 'none'; 
            highlightElements(step.affected_parts || [], step.affected_damages || []);
        }

        function showStepDetailModal() {
            if (!currentPlanJson || !currentStepId || !planMap.has(currentStepId)) return;
            const step = planMap.get(currentStepId);
            const body = document.getElementById('step-detail-modal-body');
            body.innerHTML = `
                <p>${step.description}</p>
                <b>Tools Required:</b> <ul>${(step.tools_required || ['None']).map(t => `<li>${t}</li>`).join('')}</ul>
                <b>Affected Parts:</b> <ul>${(step.affected_parts || ['None']).map(p => `<li>${p}</li>`).join('')}</ul>
                <b>Addressed Damages:</b> <ul>${(step.affected_damages || ['None']).map(d => `<li>${d}</li>`).join('')}</ul>
            `;
            document.getElementById('step-detail-modal-overlay').style.display = 'flex';
        }
        
        function populateBrainSelect() {
            brainSelect.innerHTML = `<option value="">None (Default)</option>`;
            brains.forEach(brain => {
                const option = document.createElement('option');
                option.value = brain.id;
                option.textContent = `${brain.emoji} ${brain.name}`;
                brainSelect.appendChild(option);
            });
        }

        function updateROLF(message, isTyping = false) {
            if (typingInterval) clearInterval(typingInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (isTyping) {
                let seconds = 0;
                const updateTimer = () => { rolfOutputEl.innerHTML = `${ROLF_PREFIX}${message} (${seconds}s)`; };
                updateTimer();
                timerInterval = setInterval(() => { seconds++; updateTimer(); }, 1000);
            } else {
                rolfOutputEl.innerHTML = `${ROLF_PREFIX}<span id="rolf-text"></span><span class="cursor"></span>`;
                const textEl = rolfOutputEl.querySelector('#rolf-text');
                const cursorEl = rolfOutputEl.querySelector('.cursor');
                if (!textEl || !cursorEl) return;
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < message.length) { textEl.textContent += message.charAt(i++); } 
                    else { clearInterval(typingInterval); if (cursorEl) cursorEl.style.display = 'none'; }
                }, 20);
            }
        }
        
        function handleFileUpload(event, type) { 
            const file = event.target.files[0]; if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = e => { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    if (type === 'assembly') { clearAll(); createModel(data); updateROLF("Assembly loaded. Upload damages."); } 
                    else if (type === 'damages') { createDamages(data); updateROLF("Damages loaded. Plan a repair."); } 
                    else if (type === 'plan') { processNewPlan(data); updateROLF(`Plan loaded.`); } 
                } catch (err) { updateROLF(`Error parsing ${type} file.`); } 
            }; 
            reader.readAsText(file); event.target.value = ''; 
        }

        function viewJson(type) { 
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentPlanJson }; 
            if (!dataMap[type]) { updateROLF(`No ${type} data.`); return; } 
            document.getElementById('json-view-title').textContent = `Current ${type} JSON`; 
            document.getElementById('json-view-textarea').value = JSON.stringify(dataMap[type], null, 2); 
            document.getElementById('json-view-modal-overlay').style.display = 'flex'; 
        }

        function downloadJson(type) { 
            const dataMap = { assembly: currentModelJson, damages: currentDamageJson, plan: currentPlanJson }; 
            if (!dataMap[type]) { updateROLF(`No ${type} data.`); return; } 
            const blob = new Blob([JSON.stringify(dataMap[type], null, 2)], {type: 'application/json'}); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `${(document.getElementById('object-name').value||'object').replace(/\s+/g,'_')}_${type}.json`; 
            a.click(); URL.revokeObjectURL(a.href); 
        }

        function viewGraph() {
            if (!currentPlanJson || !currentPlanJson.steps || currentPlanJson.steps.length === 0) {
                updateROLF("Generate or load a repair plan to see its graph.");
                return;
            }
            const steps = currentPlanJson.steps;
            const removeKeywords = ['remove', 'unscrew', 'detach', 'disassemble', 'pry', 'take off', 'unclip', 'sand', 'cut', 'unfasten', 'separate', 'take out', 'disconnect','clean'];
            const addKeywords = ['add', 'apply', 'install', 'attach', 'secure', 'glue', 'insert', 'place', 'reassemble', 'fill', 'coat'];
            let dot = `digraph RepairPlan {\n  rankdir=LR;\n  node [fontname="Helvetica,Arial,sans-serif", fixedsize=true, width=1.6, height=1.2];\n  edge [fontname="Helvetica,Arial,sans-serif"];\n\n`;
            steps.forEach(step => {
                const label = step.title.replace(/\s+/g, '\\n');
                const titleLower = step.title.toLowerCase();
                let attributes = [], styleProperties = [];
                let shape = 'circle';
                if (removeKeywords.some(kw => titleLower.includes(kw))) { shape = 'doublecircle'; styleProperties.push('dashed'); } 
                else if (addKeywords.some(kw => titleLower.includes(kw))) { shape = 'doublecircle'; }
                attributes.push(`shape=${shape}`);
                if (step.step_id === currentStepId) { styleProperties.push('filled'); attributes.push('fillcolor="#dd3333"', 'fontcolor=white'); } 
                // else if (!step.prerequisites || step.prerequisites.length === 0 || steps.every(s => !s.prerequisites.includes(step.step_id))) { styleProperties.push('filled'); attributes.push('fillcolor=black', 'fontcolor=white'); }
                if (styleProperties.length > 0) attributes.push(`style="${styleProperties.join(',')}"`);
                dot += `  "${step.step_id}" [label="${label}", ${attributes.join(', ')}];\n`;
            });
            steps.forEach(step => {
                if (step.prerequisites && step.prerequisites.length > 0) {
                    step.prerequisites.forEach(prereqId => { dot += `  "${prereqId}" -> "${step.step_id}";\n`; });
                }
            });
            dot += '}';
            document.getElementById('graph-title').textContent = "Repair Plan Graph";
            d3.select("#graph-container").graphviz({ useWorker: false }).engine('dot').renderDot(dot);
            document.getElementById('graph-modal-overlay').style.display = 'flex';
        }

        function onObjectClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const sphereIntersects = raycaster.intersectObjects(damageSpheres);
            const partIntersects = raycaster.intersectObjects(Array.from(partMeshesMap.values()));
            displayCurrentStep(); 
            infoBox.style.display = 'none';
            if (sphereIntersects.length > 0) {
                const clickedSphere = sphereIntersects[0].object;
                const damageInfo = clickedSphere.userData.damage;
                clickedSphere.material = selectedDotMaterial;
                infoBox.style.color = '#ff0000';
                infoBox.innerHTML = `<b>${damageInfo.type} (${damageInfo.id}):</b><br>${damageInfo.description}<br>Part: ${damageInfo.part_id}.`;
                infoBox.style.display = 'block';
            } else if (partIntersects.length > 0) {
                const clickedMesh = partIntersects[0].object;
                const partData = clickedMesh.parent.userData.part;
                clickedMesh.material = selectionPartMaterial;
                if (partData) {
                    const d = partData.dimensions;
                    infoBox.style.color = '#0000ff';
                    infoBox.innerHTML = `<b>Part:</b> ${partData.id.replace(/_/g, ' ')}<br><b>Size:</b> ${(d.width*100).toFixed(1)} x ${(d.depth*100).toFixed(1)} x ${(d.height*100).toFixed(1)} cm`;
                    infoBox.style.display = 'block';
                }
            }
        }
        
        function animateParts(isExploding) { 
            if (objectGroup.children.length === 0) return; activeAnimations = []; 
            const center = new THREE.Box3().setFromObject(objectGroup).getCenter(new THREE.Vector3()); 
            const size = new THREE.Box3().setFromObject(objectGroup).getSize(new THREE.Vector3());
            const explodeFactor = Math.max(size.x, size.y, size.z, size.length()) * 0.1;
            objectGroup.children.forEach(partGroup => { 
                if (partGroup.userData.originalPosition) { 
                    const start = partGroup.position.clone(); let end; 
                    if (isExploding) { end = partGroup.userData.originalPosition.clone().add(partGroup.userData.originalPosition.clone().sub(center).normalize().multiplyScalar(explodeFactor)); } 
                    else { end = partGroup.userData.originalPosition.clone(); } 
                    activeAnimations.push({ mesh: partGroup, start: start, end: end, startTime: performance.now() }); 
                } 
            }); 
        }

        function generateAssemblySVG(assemblyJson, damageJson) {
            const { objectName, parts } = assemblyJson || {};
            if (!parts || parts.length === 0) return '';
            const allWorldVertices = new Map();
            const globalBBox = new THREE.Box3();
            parts.forEach(part => {
                const centerPos = new THREE.Vector3(part.origin.x, part.origin.y, part.origin.z);
                const w = part.dimensions.width, h = part.dimensions.height, d = part.dimensions.depth;
                const localVertices = [ new THREE.Vector3(-w/2,-h/2,d/2), new THREE.Vector3(w/2,-h/2,d/2), new THREE.Vector3(w/2,h/2,d/2), new THREE.Vector3(-w/2,h/2,d/2), new THREE.Vector3(-w/2,-h/2,-d/2), new THREE.Vector3(w/2,-h/2,-d/2), new THREE.Vector3(w/2,h/2,-d/2), new THREE.Vector3(-w/2,h/2,-d/2) ];
                const euler = new THREE.Euler(part.rotation?.x || 0, part.rotation?.y || 0, part.rotation?.z || 0, 'YXZ');
                const quaternion = new THREE.Quaternion().setFromEuler(euler);
                const partMatrix = new THREE.Matrix4().compose(centerPos, quaternion, new THREE.Vector3(1, 1, 1));
                const worldVertices = localVertices.map(v => v.clone().applyMatrix4(partMatrix));
                allWorldVertices.set(part.id, worldVertices);
                worldVertices.forEach(v => globalBBox.expandByPoint(v));
            });
            const globalSize = globalBBox.getSize(new THREE.Vector3());
            const scale = 200, padding = 60;
            const viewWidth = Math.max(globalSize.x, globalSize.z) * scale, viewHeight = Math.max(globalSize.y, globalSize.z) * scale;
            const svgWidth = (viewWidth * 4) + (padding * 5), svgHeight = (viewHeight * 3) + (padding * 4);
            const views = {
                'TOP':    {x:viewWidth+padding*2, y:padding,               p:v=>({x:-v.x,y:-v.z}), dir:new THREE.Vector3(0,-1,0)},
                'LEFT':   {x:padding,             y:viewHeight+padding*2,  p:v=>({x:v.z, y:-v.y}), dir:new THREE.Vector3(1,0,0)},
                'FRONT':  {x:viewWidth+padding*2, y:viewHeight+padding*2,  p:v=>({x:-v.x,y:-v.y}), dir:new THREE.Vector3(0,0,-1)},
                'RIGHT':  {x:viewWidth*2+padding*3,y:viewHeight+padding*2, p:v=>({x:-v.z,y:-v.y}), dir:new THREE.Vector3(-1,0,0)},
                'BACK':   {x:viewWidth*3+padding*4,y:viewHeight+padding*2, p:v=>({x:v.x, y:-v.y}), dir:new THREE.Vector3(0,0,1)},
                'BOTTOM': {x:viewWidth+padding*2, y:viewHeight*2+padding*3,p:v=>({x:-v.x,y:v.z}),  dir:new THREE.Vector3(0,1,0)}
            };
            const faces = [[0,1,2,3],[5,4,7,6],[1,5,6,2],[4,0,3,7],[3,2,6,7],[4,5,1,0]], edges = [[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];
            let svgGroups = '';
            for (const [name, view] of Object.entries(views)) {
                const pBounds = Array.from(allWorldVertices.values()).flat().map(v => view.p(v)).reduce((a,p)=>({minX:Math.min(a.minX,p.x),minY:Math.min(a.minY,p.y),maxX:Math.max(a.maxX,p.x),maxY:Math.max(a.maxY,p.y)}),{minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity});
                const centerX = (pBounds.minX + pBounds.maxX)/2, centerY = (pBounds.minY + pBounds.maxY)/2;
                const groupTransform = `translate(${view.x}, ${view.y})`, contentTransform = `translate(${viewWidth/2}, ${viewHeight/2}) scale(${scale}) translate(${-centerX}, ${-centerY})`;
                let hiddenLinesHTML='', visibleLinesHTML='';
                parts.forEach(part => {
                    const worldVertices = allWorldVertices.get(part.id); if (!worldVertices) return;
                    const visibleEdges = new Set();
                    faces.forEach(faceIndices => {
                        const v0=worldVertices[faceIndices[0]], v1=worldVertices[faceIndices[1]], v2=worldVertices[faceIndices[2]];
                        const n = new THREE.Vector3().crossVectors(new THREE.Vector3().subVectors(v1,v0),new THREE.Vector3().subVectors(v2,v0)).normalize();
                        if (n.dot(view.dir) > 0) faceIndices.forEach((v, i) => visibleEdges.add([v, faceIndices[(i+1)%faceIndices.length]].sort().join('-')));
                    });
                    edges.forEach(edgeIndices => {
                        const p1 = view.p(worldVertices[edgeIndices[0]]), p2 = view.p(worldVertices[edgeIndices[1]]);
                        const line = `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" />`;
                        if (visibleEdges.has(edgeIndices.sort().join('-'))) visibleLinesHTML+=line; else hiddenLinesHTML+=line;
                    });
                });
                let damageMarkers = (damageJson||[]).map(d => `<circle cx="${view.p(new THREE.Vector3(d.coordinates.x,d.coordinates.y,d.coordinates.z)).x}" cy="${view.p(new THREE.Vector3(d.coordinates.x,d.coordinates.y,d.coordinates.z)).y}" r="${2/scale}" class="damage-marker" />`).join('');
                let rulerMarks = '';
                if (['TOP', 'FRONT', 'BOTTOM'].includes(name)) {
                    const relevantDimension = (name === 'FRONT') ? globalSize.y : globalSize.z, numMarks = Math.floor((relevantDimension + 1e-9) / 0.1);
                    if (numMarks > 0) {
                        const rulerX = pBounds.maxX + (20 / scale), tickLength = 15 / scale, yStep = 0.1;
                        for (let i = 1; i <= numMarks; i++) rulerMarks += `<line x1="${rulerX}" y1="${pBounds.maxY - (i * yStep)}" x2="${rulerX + tickLength}" y2="${pBounds.maxY - (i * yStep)}" stroke="black" stroke-width="${0.5 / scale}" />`;
                    }
                }
                svgGroups += `<g transform="${groupTransform}"><text x="${viewWidth/2}" y="${viewHeight+20}" text-anchor="middle" font-size="14" font-family="sans-serif">${name}</text><g transform="${contentTransform}"><g class="hidden-lines">${hiddenLinesHTML}</g><g class="visible-lines">${visibleLinesHTML}</g>${damageMarkers}${rulerMarks}</g></g>`;
            }
            const style = `<style>.visible-lines line{stroke:#000;stroke-width:${1/scale};}.hidden-lines line{stroke:#888;stroke-width:${0.5/scale};stroke-dasharray:${2.5/scale};}.damage-marker{fill:#D00;stroke:none;}.label{font-size:16px;font-family:sans-serif;}</style>`;
            return `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgWidth} ${svgHeight}">${style}<rect x="0" y="0" width="${svgWidth}" height="${svgHeight}" fill="#fff"/><text x="${padding}" y="35" class="label" font-weight="bold">Assembly: ${objectName || 'Untitled'}</text>${svgGroups}</svg>`;
        }

        function downloadAssemblyDrawing() {
            if (!currentModelJson) { updateROLF("Please load an assembly first."); return; }
            updateROLF("Generating drawing...", true);
            setTimeout(() => {
                const svgData = generateAssemblySVG(currentModelJson, currentDamageJson);
                if (!svgData) { updateROLF("Failed to generate drawing."); return; }
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${(document.getElementById('object-name').value||'assembly').replace(/\s+/g,'_')}_drawing.svg`;
                a.click();
                URL.revokeObjectURL(url);
                updateROLF("Assembly drawing downloaded.");
            }, 50);
        }

        function setupEventListeners() {
            window.addEventListener('resize', () => { const w = viewerContainer.clientWidth, h = viewerContainer.clientHeight; camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h); });
            document.getElementById('viewer-canvas').addEventListener('click', onObjectClick);
            document.getElementById('generate-plan-btn').addEventListener('click', async () => {
                if (!currentModelJson || !currentDamageJson) { updateROLF("Error: Please upload both assembly and damage files first."); return; }
                const previousStepId = currentStepId;
                updateROLF("Generating your repair plan...", true);
                try {
                    const response = await fetch('/api/plan-actions_new', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modelJson: currentModelJson, damageJson: currentDamageJson, userPrompt: userPromptInput.value, existingPlan: currentPlanJson, brainId: selectedBrainId, geminiModel, temperature })
                    });
                    if (timerInterval) clearInterval(timerInterval);
                    if (!response.ok) throw new Error((await response.json()).message || 'Server error');
                    const result = await response.json();
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response structure.");
                    const newPlan = JSON.parse(result.candidates[0].content.parts[0].text.replace(/```json\n|```/g, '').trim());
                    processNewPlan(newPlan);
                    if (previousStepId && planMap.has(previousStepId)) { currentStepId = previousStepId; displayCurrentStep(); }
                    updateROLF(`Plan generated with ${newPlan.steps.length} steps.`, false);
                    userPromptInput.value = '';
                } catch (error) { updateROLF(`Sorry, an error occurred: ${error.message}`, false); }
            });
            document.getElementById('create-intervention-btn').addEventListener('click', async () => {
                if (!currentModelJson) { updateROLF("Error: Please load an assembly first to modify it."); return; }
                const promptText = userPromptInput.value.trim();
                if (!promptText) { updateROLF("Please describe the intervention (e.g., 'add a support')."); return; }
                updateROLF("Applying intervention...", true);
                try {
                    const response = await fetch('/api/create-intervention', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modelJson: currentModelJson, userPrompt: promptText, geminiModel, temperature })
                    });
                    if (timerInterval) clearInterval(timerInterval);
                    if (!response.ok) throw new Error((await response.json()).message || 'Server error');
                    const result = await response.json();
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response structure for intervention.");
                    const newModelJson = JSON.parse(result.candidates[0].content.parts[0].text.replace(/```json\n|```/g, '').trim());
                    const newParts = newModelJson.parts.filter(p => p.status === 'new').length;
                    const discardedParts = newModelJson.parts.filter(p => p.status === 'discarded').length;
                    let rolfMsg = "Intervention applied.";
                    if (newParts > 0) rolfMsg += ` ${newParts} new part(s) added.`;
                    if (discardedParts > 0) rolfMsg += ` ${discardedParts} part(s) marked for discard.`;
                    createModel(newModelJson);
                    createDamages(currentDamageJson);
                    displayCurrentStep();
                    updateROLF(rolfMsg, false);
                    userPromptInput.value = '';
                } catch (error) { updateROLF(`Intervention failed: ${error.message}`, false); }
            });
            explodeBtn.addEventListener('click', () => { animateParts(true); explodeBtn.style.display = 'none'; resetBtn.style.display = 'inline-block'; });
            resetBtn.addEventListener('click', () => { animateParts(false); resetBtn.style.display = 'none'; explodeBtn.style.display = 'inline-block'; });
            settingsBtn.addEventListener('click', () => { brainSelect.value = selectedBrainId || ""; modelSelect.value = geminiModel; temperatureSlider.value = temperature; temperatureValue.textContent = temperature; sphereScaleSlider.value = sphereScale; sphereScaleValue.textContent = sphereScale.toFixed(2); settingsModal.style.display = 'flex'; });
            saveSettingsBtn.addEventListener('click', () => { selectedBrainId = brainSelect.value; geminiModel = modelSelect.value; temperature = parseFloat(temperatureSlider.value); sphereScale = parseFloat(sphereScaleSlider.value); settingsModal.style.display = 'none'; const brainName = brains.find(b => b.id === selectedBrainId)?.name || 'Default'; updateROLF(`Settings updated. Brain: ${brainName}.`); });
            temperatureSlider.addEventListener('input', () => { temperatureValue.textContent = temperatureSlider.value; });
            sphereScaleSlider.addEventListener('input', () => { sphereScaleValue.textContent = parseFloat(sphereScaleSlider.value).toFixed(2); });
            let currentAction = '';
            const openChoiceModal = (action) => { currentAction = action; document.getElementById('data-choice-title').textContent = `What to ${action}?`; document.getElementById('data-choice-modal-overlay').style.display = 'flex'; };
            const choiceActions = { upload: (type) => document.getElementById(`${type}-upload-input`).click(), copy: (type) => viewJson(type), download: (type) => downloadJson(type) };
            document.getElementById('upload-json-btn').addEventListener('click', () => openChoiceModal('upload'));
            document.getElementById('copy-json-btn').addEventListener('click', () => openChoiceModal('copy'));
            document.getElementById('download-json-btn').addEventListener('click', () => openChoiceModal('download'));
            document.getElementById('view-plan-graph-btn').addEventListener('click', viewGraph);
            document.getElementById('download-drawings-btn').addEventListener('click', downloadAssemblyDrawing);
            document.getElementById('assembly-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'assembly'));
            document.getElementById('damages-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'damages'));
            document.getElementById('plan-upload-input').addEventListener('change', (e) => handleFileUpload(e, 'plan'));
            document.getElementById('choice-btn-assembly').addEventListener('click', () => { choiceActions[currentAction]?.('assembly'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
            document.getElementById('choice-btn-damages').addEventListener('click', () => { choiceActions[currentAction]?.('damages'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
            document.getElementById('choice-btn-plan').addEventListener('click', () => { choiceActions[currentAction]?.('plan'); document.getElementById('data-choice-modal-overlay').style.display = 'none'; });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', e => e.target.closest('.modal-overlay').style.display = 'none'));
            document.getElementById('copy-json-from-modal-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('json-view-textarea').value).then(() => { updateROLF("JSON copied."); document.getElementById('json-view-modal-overlay').style.display = 'none'; }); });
            document.getElementById('save-graph-svg-btn').addEventListener('click', () => { const svgEl = document.querySelector('#graph-container svg'); if (!svgEl) return; svgEl.setAttribute("xmlns", "http://www.w3.org/2000/svg"); const blob = new Blob([new XMLSerializer().serializeToString(svgEl)], { type: "image/svg+xml;charset=utf-8" }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${(document.getElementById('object-name').value||'object').replace(/\s+/g,'_')}_graph.svg`; a.click(); URL.revokeObjectURL(a.href); updateROLF("Graph saved as SVG."); });
            stepNavPrevBtn.addEventListener('click', () => {
                if (stepHistory.length > 0) {
                    currentStepId = stepHistory.pop();
                    displayCurrentStep();
                }
            });
            stepInfoPanel.addEventListener('click', showStepDetailModal);
        }
        
        init();
    </script>
</body>
</html>